<div
  #scrollContainer
  class="view-model-scroll-container model-detail-container"
  [class.slide-out-to-left]="isEditing"
  [class.slide-in-from-left]="!isEditing">
  <div class="view-content-wrapper">
    <div class="back-navigation">
      <button mat-button class="back-btn" (click)="onBackToModels()">
        <mat-icon>arrow_back</mat-icon>
        <span>Back to Models</span>
      </button>
    </div>

    <div class="model-header">
      <div class="header-left">
        <div class="page-category">Normalization</div>
        <h1 class="model-title">{{ modelData?.name || 'Patient Model' }}</h1>

        <div class="header-metadata">
          <button mat-button class="metadata-pill type-pill">
            <mat-icon>category</mat-icon>
            <span>{{ modelData?.modelType || 'Canonical' }}</span>
          </button>

          <div
            class="status-pill"
            [class.active]="modelData?.status === 'Active' || !modelData?.status"
            [class.deprecated]="modelData?.status === 'Deprecated'"
            [class.draft]="modelData?.status === 'Draft'"
            [class.archived]="modelData?.status === 'Archived'">
            <mat-icon>
              @if (modelData?.status === 'Active' || !modelData?.status) {
                check_circle
              } @else if (modelData?.status === 'Deprecated') {
                block
              } @else if (modelData?.status === 'Archived') {
                archive
              } @else {
                edit_note
              }
            </mat-icon>
            <span>{{ modelData?.status || 'Active' }}</span>
          </div>
        </div>
      </div>

      <div class="header-actions">
        <button mat-button class="edit-btn" (click)="onEdit()">
          <mat-icon>edit</mat-icon>
          <span>Edit</span>
        </button>

        <button mat-button class="status-dropdown-btn" [matMenuTriggerFor]="statusMenu">
          <span>Change Status</span>
          <mat-icon>expand_more</mat-icon>
        </button>

        <mat-menu #statusMenu="matMenu">
          <button
            mat-menu-item
            (click)="onChangeStatus('Draft')"
            [disabled]="modelData?.status === 'Draft'">
            <mat-icon>edit_note</mat-icon>
            <span>Draft {{ modelData?.status === 'Draft' ? '(current)' : '' }}</span>
          </button>

          <button
            mat-menu-item
            (click)="onChangeStatus('Active')"
            [disabled]="modelData?.status === 'Active' || !modelData?.status">
            <mat-icon class="status-active">check_circle</mat-icon>
            <span
              >Active
              {{ modelData?.status === 'Active' || !modelData?.status ? '(current)' : '' }}</span
            >
          </button>

          <mat-divider></mat-divider>

          <button
            mat-menu-item
            class="warning-action"
            (click)="onChangeStatus('Deprecated')"
            [disabled]="modelData?.status === 'Deprecated'">
            <mat-icon>block</mat-icon>
            <span>Deprecated {{ modelData?.status === 'Deprecated' ? '(current)' : '' }}</span>
          </button>

          <button
            mat-menu-item
            class="danger-action"
            (click)="onChangeStatus('Archived')"
            [disabled]="modelData?.status === 'Archived'">
            <mat-icon>archive</mat-icon>
            <span>Archived {{ modelData?.status === 'Archived' ? '(current)' : '' }}</span>
          </button>
        </mat-menu>
      </div>
    </div>

    <div class="content-grid">
      <div class="left-column">
        <div class="info-block overview-block">
          <h2 class="block-title">Overview</h2>
          <p class="description">
            {{
              modelData?.description ||
                'The core representation of a patient entity for unified medical data normalization. Contains demographics, identifiers, contacts, and key healthcare data points.'
            }}
          </p>

          <div class="aliases-section">
            <label class="section-label">Aliases</label>
            <div class="aliases-chips">
              @for (alias of aliases; track alias) {
                <mat-chip class="alias-chip">{{ alias }}</mat-chip>
              }
            </div>
          </div>

          <div class="info-grid">
            <div class="info-item">
              <label>Canonical Identifier Field</label>
              <span class="field-name">{{
                modelData?.identifierField || 'patient_canonical_id'
              }}</span>
            </div>
            <div class="info-item">
              <label>Owner</label>
              <span>{{ modelData?.owner || 'Data Governance Team' }}</span>
            </div>
            <div class="info-item">
              <label>Created</label>
              <span>{{ modelData?.created || '2024-01-15 by Dmitry' }}</span>
            </div>
            <div class="info-item">
              <label>Last Modified</label>
              <span>{{ modelData?.lastModified || '2024-02-07 by Dmitry' }}</span>
            </div>
          </div>
        </div>

        <div class="fields-section">
          <h2 class="section-title">Fields</h2>
          <p class="section-subtitle">Inspect model structure without becoming a schema editor.</p>

          <div class="fields-filters">
            <div class="search-box">
              <mat-icon>search</mat-icon>
              <input
                type="text"
                placeholder="Search fields..."
                [(ngModel)]="fieldsSearchTerm"
                (input)="applyFieldsFilter()" />
            </div>

            <div class="rows-count">
              1 â€“ {{ fieldsDataSource.data.length }} of {{ fieldsDataSource.data.length }} fields
            </div>
          </div>

          <table
            mat-table
            [dataSource]="fieldsDataSource"
            matSort
            #fieldsSort="matSort"
            class="fields-table">
            <ng-container matColumnDef="fieldName">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Field Name</th>
              <td mat-cell *matCellDef="let element" class="field-name">
                {{ element.fieldName }}
              </td>
            </ng-container>

            <ng-container matColumnDef="type">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Type</th>
              <td mat-cell *matCellDef="let element">{{ element.type }}</td>
            </ng-container>

            <ng-container matColumnDef="requirement">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Required / Optional</th>
              <td mat-cell *matCellDef="let element">
                <span [class.required-field]="element.requirement === 'Required'">
                  {{ element.requirement }}
                </span>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="fieldsColumns; sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: fieldsColumns"></tr>
          </table>

          <mat-paginator
            #fieldsPaginator
            [pageSize]="10"
            [pageSizeOptions]="[5, 10, 20]"></mat-paginator>
        </div>

        <div class="dependencies-section">
          <h2 class="section-title">Dependencies</h2>
          <p class="section-subtitle">
            Models structurally related through mappings, rules, or graph relationships.
          </p>

          <mat-tab-group class="dependencies-tabs">
            <mat-tab label="Related Models">
              <div class="tab-content">
                @if (relatedModelsDataSource.data.length > 0) {
                  <table
                    mat-table
                    [dataSource]="relatedModelsDataSource"
                    matSort
                    #relatedSort="matSort"
                    class="dependency-table">
                    <ng-container matColumnDef="modelName">
                      <th mat-header-cell *matHeaderCellDef mat-sort-header>Model Name</th>
                      <td mat-cell *matCellDef="let element">
                        <a class="model-link" (click)="viewRelatedModel(element)">
                          {{ element.modelName }}
                        </a>
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="relationshipContext">
                      <th mat-header-cell *matHeaderCellDef mat-sort-header>
                        Relationship Context
                      </th>
                      <td mat-cell *matCellDef="let element">{{ element.relationshipContext }}</td>
                    </ng-container>

                    <ng-container matColumnDef="references">
                      <th mat-header-cell *matHeaderCellDef mat-sort-header>References</th>
                      <td mat-cell *matCellDef="let element">
                        <span class="reference-count">{{ element.references }}</span>
                      </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="relatedModelsColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: relatedModelsColumns"></tr>
                  </table>

                  <mat-paginator
                    #relatedPaginator
                    [pageSize]="5"
                    [pageSizeOptions]="[5, 10]"></mat-paginator>

                  <div class="dependency-footer">
                    Showing {{ relatedModelsDataSource.data.length }} related models
                  </div>
                } @else {
                  <div class="empty-state">
                    <p>No related models found.</p>
                    <p class="empty-state-detail">
                      This model is not currently related to other canonical models through
                      documented relationships.
                    </p>
                  </div>
                }
              </div>
            </mat-tab>

            <mat-tab label="Upstream">
              <div class="tab-content">
                @if (upstreamDataSource.data.length > 0) {
                  <table
                    mat-table
                    [dataSource]="upstreamDataSource"
                    matSort
                    #upstreamSort="matSort"
                    class="dependency-table">
                    <ng-container matColumnDef="sourceName">
                      <th mat-header-cell *matHeaderCellDef mat-sort-header>Source Name</th>
                      <td mat-cell *matCellDef="let element">
                        <a class="source-link" (click)="viewUpstreamSource(element.sourceName)">
                          {{ element.sourceName }}
                        </a>
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="type">
                      <th mat-header-cell *matHeaderCellDef mat-sort-header>Type</th>
                      <td mat-cell *matCellDef="let element">{{ element.type }}</td>
                    </ng-container>

                    <ng-container matColumnDef="status">
                      <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
                      <td mat-cell *matCellDef="let element">
                        <span
                          class="status-badge"
                          [class.active]="element.status === 'Active'"
                          [class.draft]="element.status === 'Draft'"
                          [class.deprecated]="element.status === 'Deprecated'">
                          {{ element.status }}
                        </span>
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="lastUpdated">
                      <th mat-header-cell *matHeaderCellDef mat-sort-header>Last Updated</th>
                      <td mat-cell *matCellDef="let element">{{ element.lastUpdated }}</td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="upstreamColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: upstreamColumns"></tr>
                  </table>

                  <mat-paginator
                    #upstreamPaginator
                    [pageSize]="5"
                    [pageSizeOptions]="[5, 10]"></mat-paginator>

                  <div class="dependency-footer">
                    Showing {{ upstreamDataSource.data.length }} upstream dependencies
                  </div>
                } @else {
                  <div class="empty-state">
                    <p>No upstream dependencies found.</p>
                    <p class="empty-state-detail">
                      This model is not currently derived from any registered source schemas or
                      datasets.
                    </p>
                  </div>
                }
              </div>
            </mat-tab>

            <mat-tab label="Downstream">
              <div class="tab-content">
                @if (downstreamDataSource.data.length > 0) {
                  <table
                    mat-table
                    [dataSource]="downstreamDataSource"
                    matSort
                    #downstreamSort="matSort"
                    class="dependency-table">
                    <ng-container matColumnDef="dependentName">
                      <th mat-header-cell *matHeaderCellDef mat-sort-header>Dependent Name</th>
                      <td mat-cell *matCellDef="let element">
                        <a
                          class="dependent-link"
                          (click)="viewDownstreamDependency(element.dependentName)">
                          {{ element.dependentName }}
                        </a>
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="type">
                      <th mat-header-cell *matHeaderCellDef mat-sort-header>Type</th>
                      <td mat-cell *matCellDef="let element">{{ element.type }}</td>
                    </ng-container>

                    <ng-container matColumnDef="status">
                      <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
                      <td mat-cell *matCellDef="let element">
                        <span
                          class="status-badge"
                          [class.active]="element.status === 'Active'"
                          [class.inactive]="element.status === 'Inactive'"
                          [class.draft]="element.status === 'Draft'"
                          [class.deprecated]="element.status === 'Deprecated'">
                          {{ element.status }}
                        </span>
                      </td>
                    </ng-container>

                    <ng-container matColumnDef="environment">
                      <th mat-header-cell *matHeaderCellDef mat-sort-header>Environment</th>
                      <td mat-cell *matCellDef="let element">
                        <span class="environment-badge" *ngIf="element.environment !== '-'">
                          {{ element.environment }}
                        </span>
                        <span *ngIf="element.environment === '-'" class="empty-cell">-</span>
                      </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="downstreamColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: downstreamColumns"></tr>
                  </table>

                  <mat-paginator
                    #downstreamPaginator
                    [pageSize]="5"
                    [pageSizeOptions]="[5, 10]"></mat-paginator>

                  <div class="dependency-footer">
                    Showing {{ downstreamDataSource.data.length }} downstream dependencies
                  </div>
                } @else {
                  <div class="empty-state">
                    <p>No downstream dependencies found.</p>
                    <p class="empty-state-detail">
                      This model is not currently referenced by any pipelines, rules, or mappings.
                    </p>
                  </div>
                }
              </div>
            </mat-tab>
          </mat-tab-group>
        </div>
      </div>

      <div class="right-column">
        <div class="info-block usage-impact-block">
          <h3 class="block-title">Usage & Impact</h3>
          <p class="block-subtitle">
            Make downstream consequences explicit before edits or lifecycle changes.
          </p>

          <div class="usage-metrics">
            <div class="metric-row clickable" (click)="viewMappings()">
              <label>Mappings referencing model</label>
              <span class="metric-value">
                {{ mappingsCount }}
                <mat-icon class="navigate-icon">arrow_forward</mat-icon>
              </span>
            </div>
            <div class="metric-row clickable" (click)="viewRules()">
              <label>Rules referencing model</label>
              <span class="metric-value">
                {{ rulesCount }}
                <mat-icon class="navigate-icon">arrow_forward</mat-icon>
              </span>
            </div>
            <div class="metric-row clickable" (click)="viewPipelines()">
              <label>Used in pipelines</label>
              <span class="metric-value">
                {{ usedInPipelines }}
                <mat-icon class="navigate-icon">arrow_forward</mat-icon>
              </span>
            </div>
            <div class="metric-row">
              <label>Exposed via API</label>
              <span
                class="metric-value"
                [class.yes-text]="exposedViaAPI"
                [class.no-text]="!exposedViaAPI">
                {{ exposedViaAPI ? 'Yes' : 'No' }}
              </span>
            </div>
            <div class="metric-row">
              <label>Used in graph</label>
              <span
                class="metric-value"
                [class.yes-text]="usedInGraph"
                [class.no-text]="!usedInGraph">
                {{ usedInGraph ? 'Yes' : 'No' }}
              </span>
            </div>
          </div>
        </div>

        <div class="info-block status-block">
          <h3 class="block-title">Status</h3>
          <div
            class="status-pill large"
            [class.active]="modelData?.status === 'Active' || !modelData?.status"
            [class.deprecated]="modelData?.status === 'Deprecated'"
            [class.draft]="modelData?.status === 'Draft'"
            [class.archived]="modelData?.status === 'Archived'">
            <mat-icon>
              @if (modelData?.status === 'Active' || !modelData?.status) {
                check_circle
              } @else if (modelData?.status === 'Deprecated') {
                block
              } @else if (modelData?.status === 'Archived') {
                archive
              } @else {
                edit_note
              }
            </mat-icon>
            <span>{{ modelData?.status || 'Active' }}</span>
          </div>
          <p class="status-description">
            @if (modelData?.status === 'Deprecated') {
              This model is legacy and no longer recommended for active normalization.
            } @else if (modelData?.status === 'Archived') {
              This model has been archived and is no longer available for use.
            } @else if (modelData?.status === 'Draft') {
              This model is in draft state and not yet ready for production use.
            } @else {
              Used in canonical normalization and downstream systems.
            }
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
