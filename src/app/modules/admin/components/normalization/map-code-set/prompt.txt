You must figure out why passing code data from openn modal new-code-set-modal.component.ts and into
map-code-set.comoponent.ts fails, where the payload passed via ngrx is invalid and why similarly passed data
from normalization component succeeds to be populated. When new code set is created in modal, with potentially codes
in it - it optionally passed at step 5 to the Map Code Set window, but that fails because the format and tata passed
does not match what can be displayed in the table, does not match authority format in dropdown and table format in html

Below are the files you will need to inspect and fix: 

(base) ➜  graph-db-frontend-new git:(devel-0.0.2) ✗ cat src/app/modules/admin/components/normalization/map-code-set/map-code-set.component.ts 
import { CommonModule } from '@angular/common';
import {
  AfterViewInit,
  Component,
  EventEmitter,
  HostBinding,
  Input,
  OnChanges,
  OnDestroy,
  OnInit,
  Output,
  SimpleChanges,
  ViewChild,
} from '@angular/core';
import { FormControl, ReactiveFormsModule } from '@angular/forms';
import { MatButtonModule } from '@angular/material/button';
import { MatCheckboxModule } from '@angular/material/checkbox';
import { MatDividerModule } from '@angular/material/divider';
import { MatFormFieldModule } from '@angular/material/form-field';
import { MatIconModule } from '@angular/material/icon';
import { MatInputModule } from '@angular/material/input';
import { MatMenuModule } from '@angular/material/menu';
import { MatPaginator, MatPaginatorModule } from '@angular/material/paginator';
import { MatProgressBarModule } from '@angular/material/progress-bar';
import { MatSelectModule } from '@angular/material/select';
import { MatSlideToggleModule } from '@angular/material/slide-toggle';
import { MatSort, MatSortModule } from '@angular/material/sort';
import { MatTableDataSource, MatTableModule } from '@angular/material/table';
import { MatTooltipModule } from '@angular/material/tooltip';
import { SelectionModel } from '@angular/cdk/collections';
import { EventService } from '@modules/events/services/event.service';
import { EventState } from '@modules/events/states/event.state';
import { Store } from '@ngrx/store';
import { Subscription } from 'rxjs';

interface MappingRow {
  id: string;
  sourceCode: string;
  sourceLabel: string;
  targetCode: string;
  targetLabel: string;
  mappingType: 'Direct' | 'Default' | 'Null / Ignore';
  hasWarning: boolean;
  warningMessage?: string;
  existingMapping?: {
    type: string;
    targetCode: string;
  };
}

@Component({
  selector: 'app-map-code-set',
  standalone: true,
  imports: [
    CommonModule,
    ReactiveFormsModule,
    MatButtonModule,
    MatCheckboxModule,
    MatIconModule,
    MatDividerModule,
    MatFormFieldModule,
    MatInputModule,
    MatSelectModule,
    MatMenuModule,
    MatTooltipModule,
    MatTableModule,
    MatSortModule,
    MatPaginatorModule,
    MatProgressBarModule,
    MatSlideToggleModule,
  ],
  templateUrl: './map-code-set.component.html',
  styleUrl: './map-code-set.component.scss',
})
export class MapCodeSetComponent implements OnInit, AfterViewInit, OnDestroy, OnChanges {
  @Input() mappingData: any = null;
  @Output() closeMapping = new EventEmitter<void>();

  @HostBinding('class.slide-out-to-right') isExiting = false;

  @ViewChild(MatSort) sort!: MatSort;
  @ViewChild(MatPaginator) paginator!: MatPaginator;

  private eventSubs?: Subscription;

  // Form controls
  nameControl = new FormControl('');
  descriptionControl = new FormControl('');
  targetCodeSetControl = new FormControl('');
  showUnmappedControl = new FormControl(false);

  // Table data
  dataSource = new MatTableDataSource<MappingRow>([]);
  selection = new SelectionModel<MappingRow>(true, []); // multi-select
  displayedColumns: string[] = [
    'select',
    'sourceCode',
    'sourceLabel',
    'targetCode',
    'targetLabel',
    'mappingType',
    'status',
  ];

  // Available options
  targetCodeSets = ['LOINC', 'SNOMED CT', 'ICD-10', 'RxNorm', 'CPT'];
  mappingTypeOptions = ['Direct', 'Default', 'Null / Ignore'];

  // Available target codes (populated based on selected code set)
  availableTargetCodes: { code: string; label: string }[] = [];

  // Status tracking
  isDraft = true;
  hasUnsavedChanges = false;

  // Progress tracking
  totalCodes = 0;
  mappedCount = 0;
  unmappedCount = 0;
  overridesCount = 0;

  // Selected row for warning display
  selectedRow: MappingRow | null = null;

  // Original data for comparison
  private originalData: MappingRow[] = [];

  constructor(
    private eventService: EventService,
    private eventStore: Store<{ nf: EventState }>,
  ) {}

  ngOnInit(): void {
    this.subscribeToEvents();
    this.updateBreadcrumb();
    this.setupTableSort();
    this.setupFilterListener();
  }

  ngAfterViewInit(): void {
    this.dataSource.sort = this.sort;
    this.dataSource.paginator = this.paginator;
  }

  ngOnChanges(changes: SimpleChanges): void {
    if (changes['mappingData'] && changes['mappingData'].currentValue) {
      this.initializeData();
    }
  }

  ngOnDestroy(): void {
    if (this.eventSubs) {
      this.eventSubs.unsubscribe();
    }
  }

  private initializeData(): void {
    if (!this.mappingData) {
      console.warn('[MapCodeSet] No mappingData provided');
      this.dataSource.data = [];
      this.originalData = [];
      this.updateCounts();
      return;
    }

    const sourceCodeSet = this.mappingData.sourceCodeSet || 'Lab Result Codes';
    let targetCodeSet = this.mappingData.targetCodeSet || '';

    // ✅ AUTO-DETECT TARGET CODE SET FROM SOURCE NAME
    if (!targetCodeSet) {
      targetCodeSet = this.detectTargetCodeSet(sourceCodeSet);
      if (targetCodeSet) {
        console.log(`[MapCodeSet] Auto-detected target code set: ${targetCodeSet}`);
      }
    }

    // Pre-fill name
    const autoName = targetCodeSet 
      ? `${sourceCodeSet} → ${targetCodeSet}`
      : `${sourceCodeSet} → [Select Target]`;
    this.nameControl.setValue(autoName);
    
    // Set target code set control (triggers loadTargetCodes)
    this.targetCodeSetControl.setValue(targetCodeSet);

    // Initialize table data
    const sourceCodeRows = this.mappingData.sourceCodeRows || [];
    console.log('[MapCodeSet] Initializing with', sourceCodeRows.length, 'rows');

    const rows: MappingRow[] = sourceCodeRows.map((row: any, index: number) => ({
      id: row.id || `row-${index}`,
      sourceCode: row.sourceCode || '',
      sourceLabel: row.sourceLabel || '',
      targetCode: row.targetCode || '',
      targetLabel: row.targetLabel || '',
      mappingType: row.mappingType || 'Direct',
      hasWarning: row.hasWarning || false,
      warningMessage: row.warningMessage,
      existingMapping: row.existingMapping,
    }));

    this.dataSource.data = rows;
    this.originalData = JSON.parse(JSON.stringify(rows));
    
    this.updateCounts();

    // Load target codes if we have a target code set
    if (targetCodeSet) {
      this.loadTargetCodes(targetCodeSet);
    }
  }

  /**
   * Detects target code set from source code set name
   * Examples:
   * - "LOINC Codes" → "LOINC"
   * - "SNOMED CT Terminology" → "SNOMED CT"
   * - "My Custom Code Set" → "" (no match)
   */
  private detectTargetCodeSet(sourceCodeSet: string): string {
    const normalized = sourceCodeSet.toLowerCase();
    
    // Check for exact matches first
    if (this.targetCodeSets.includes(sourceCodeSet)) {
      return sourceCodeSet;
    }

    // Check for partial matches
    for (const option of this.targetCodeSets) {
      if (normalized.includes(option.toLowerCase())) {
        return option;
      }
    }

    // Special cases
    if (normalized.includes('loinc')) return 'LOINC';
    if (normalized.includes('snomed')) return 'SNOMED CT';
    if (normalized.includes('icd-10')) return 'ICD-10';
    if (normalized.includes('rxnorm')) return 'RxNorm';
    if (normalized.includes('cpt')) return 'CPT';

    return ''; // No match found
  }

  private subscribeToEvents(): void {
    this.eventSubs = this.eventStore.select('nf').subscribe((state: any) => {
      const eventName = state?.items?.event;
      const eventData = state?.items?.payload;

      // Handle close event
      if (eventName === 'close_map_code_set') {
        this.onCancel();
      }

      // Handle confirmation responses
      if (eventName === 'confirmation_response' && eventData) {
        this.handleConfirmationResponse(eventData);
      }
    });
  }

  private handleConfirmationResponse(data: any): void {
    const { confirmed, command } = data;

    if (!confirmed) {
      return;
    }

    switch (command) {
      case 'save_code_mapping':
        this.finalizeSave();
        break;
      case 'discard':
        this.discardChangesAndClose();
        break;
    }
  }

  private updateBreadcrumb(): void {
    const sourceCodeSet = this.mappingData?.sourceCodeSet || 'Code Set';
    
    const breadcrumbPath = [
      { label: 'Normalization', target: 'ROOT' },
      { label: 'Codes', target: 'TAB_CODES' },
      { label: `Map: ${sourceCodeSet}`, target: 'MAP_CODE_SET', active: true },
    ];

    this.eventService.publish('nf', 'update_breadcrumb', { path: breadcrumbPath });
  }

  private setupTableSort(): void {
    setTimeout(() => {
      if (this.sort) {
        this.dataSource.sort = this.sort;
      }
    }, 0);
  }

  private setupFilterListener(): void {
    this.showUnmappedControl.valueChanges.subscribe(showUnmapped => {
      if (showUnmapped) {
        this.dataSource.filterPredicate = (data: MappingRow) => {
          return !data.targetCode || data.targetCode === '';
        };
        this.dataSource.filter = 'unmapped';
      } else {
        this.dataSource.filterPredicate = () => true;
        this.dataSource.filter = '';
      }

      // Reset pagination when filter changes (important!)
      if (this.paginator) {
        this.paginator.firstPage();
      }
    });
  }

  // Target code set selection
  onTargetCodeSetChange(): void {
    const targetCodeSet = this.targetCodeSetControl.value;
    if (targetCodeSet) {
      this.loadTargetCodes(targetCodeSet);
      this.updateMappingName();
      this.trackChange();
    }
  }

  private loadTargetCodes(codeSet: string): void {
    // Mock data - in production, fetch from API
    const codesBySystem: Record<string, { code: string; label: string }[]> = {
      'LOINC': [
        { code: '2951-2', label: 'Sodium [Moles/volume]' },
        { code: '2345-7', label: 'Glucose [Mass/volume]' },
        { code: '718-7', label: 'Hemoglobin [Mass/volume]' },
        { code: '4548-4', label: 'C-Reactive Protein [Mass/volume]' },
        { code: '1988-5', label: 'C-Reactive Protein [Mass/volume]' },
        { code: '6598-7', label: 'Troponin I [Mass/volume]' },
        { code: '20426-5', label: 'Borrelia burgdorferi Ab' },
        { code: '50190-4', label: 'Vitamin D [Moles/volume]' },
      ],
      'SNOMED CT': [
        { code: '44054006', label: 'Diabetes mellitus type 2' },
        { code: '73211009', label: 'Diabetes mellitus' },
        { code: '271649006', label: 'Hemoglobin A1c' },
      ],
      'ICD-10': [
        { code: 'E11.9', label: 'Type 2 diabetes mellitus without complications' },
        { code: 'E11.65', label: 'Type 2 diabetes mellitus with hyperglycemia' },
        { code: 'Z79.4', label: 'Long-term (current) use of insulin' },
      ],
      'RxNorm': [
        { code: '197737', label: 'Metformin 500 MG Oral Tablet' },
        { code: '860975', label: 'Insulin Glargine 100 UNT/ML Injectable Solution' },
      ],
      'CPT': [
        { code: '80053', label: 'Comprehensive metabolic panel' },
        { code: '83036', label: 'Hemoglobin; glycosylated (A1c)' },
      ],
    };

    this.availableTargetCodes = codesBySystem[codeSet] || [];
  }

  private updateMappingName(): void {
    const sourceCodeSet = this.mappingData?.sourceCodeSet || 'Lab Result Codes';
    const targetCodeSet = this.targetCodeSetControl.value || '[Select Target]';
    const autoName = `${sourceCodeSet} → ${targetCodeSet}`;
    this.nameControl.setValue(autoName);
  }

  // Table interactions - Selection
  isAllSelected(): boolean {
    const numSelected = this.selection.selected.length;
    const numRows = this.dataSource.data.length;
    return numSelected === numRows && numRows > 0;
  }

  isSomeSelected(): boolean {
    const numSelected = this.selection.selected.length;
    return numSelected > 0 && numSelected < this.dataSource.data.length;
  }

  masterToggle(): void {
    if (this.isAllSelected()) {
      this.selection.clear();
    } else {
      this.dataSource.data.forEach(row => this.selection.select(row));
    }
  }

  checkboxLabel(row?: MappingRow): string {
    if (!row) {
      return `${this.isAllSelected() ? 'select' : 'deselect'} all`;
    }
    return `${this.selection.isSelected(row) ? 'deselect' : 'select'} row`;
  }

  onTargetCodeChange(row: MappingRow, event: any): void {
    const selectedCode = event.value;
    const targetInfo = this.availableTargetCodes.find(t => t.code === selectedCode);
    
    if (targetInfo) {
      row.targetCode = targetInfo.code;
      row.targetLabel = targetInfo.label;
    }

    // Check for overrides
    this.checkForOverride(row);
    
    this.updateCounts();
    this.trackChange();
  }

  onMappingTypeChange(row: MappingRow, event: any): void {
    row.mappingType = event.value;
    
    // If changed to "Null / Ignore", clear target
    if (row.mappingType === 'Null / Ignore') {
      row.targetCode = '';
      row.targetLabel = '';
      row.hasWarning = false;
    }
    
    this.updateCounts();
    this.trackChange();
  }

  private checkForOverride(row: MappingRow): void {
    // Simulate override detection - in production, check against existing mappings
    const hasExisting = Math.random() > 0.8; // 20% chance of override for demo
    
    if (hasExisting && row.targetCode) {
      row.hasWarning = true;
      row.warningMessage = 'Override detected';
      row.existingMapping = {
        type: 'Code Set',
        targetCode: 'LOINC:' + row.targetCode,
      };
      this.overridesCount++;
    } else {
      row.hasWarning = false;
      row.warningMessage = undefined;
      row.existingMapping = undefined;
    }
  }

  onRowClick(row: MappingRow): void {
    if (row.hasWarning) {
      this.selectedRow = row;
    }
  }

  // Progress tracking
  private updateCounts(): void {
    this.totalCodes = this.dataSource.data.length;
    this.mappedCount = this.dataSource.data.filter(
      row => row.targetCode && row.targetCode !== ''
    ).length;
    this.unmappedCount = this.totalCodes - this.mappedCount;
    this.overridesCount = this.dataSource.data.filter(row => row.hasWarning).length;
  }

  get mappingProgress(): number {
    if (this.totalCodes === 0) return 0;
    return (this.mappedCount / this.totalCodes) * 100;
  }

  get progressBarColor(): string {
    if (this.mappingProgress < 30) return 'warn';
    if (this.mappingProgress < 70) return 'accent';
    return 'primary';
  }

  // Change tracking
  public trackChange(): void {
    this.hasUnsavedChanges = true;
    this.isDraft = true;
  }

  private hasChanges(): boolean {
    return JSON.stringify(this.dataSource.data) !== JSON.stringify(this.originalData);
  }

  // Actions
  onSave(): void {
    if (!this.targetCodeSetControl.value) {
      alert('Please select a target code set');
      return;
    }

    if (this.mappedCount === 0) {
      alert('Please map at least one code before saving');
      return;
    }

    // Open confirmation modal
    const theme = this.getActiveTheme();
    this.eventService.publish('nf', 'open_confirmation_modal', {
      title: 'Save Mapping?',
      message: `Save mapping with ${this.mappedCount} of ${this.totalCodes} codes mapped?`,
      command: 'save_code_mapping',
      itemName: this.nameControl.value || 'Code Set Mapping',
      theme,
      action: 'save',
    });
  }

  onCancel(): void {
    if (this.hasChanges()) {
      const theme = this.getActiveTheme();
      this.eventService.publish('nf', 'open_confirmation_modal', {
        title: 'Discard Changes?',
        message: 'You have unsaved mapping changes. Are you sure you want to discard them?',
        command: 'discard',
        itemName: this.nameControl.value || 'Code Set Mapping',
        theme,
        action: 'discard',
      });
    } else {
      this.executeClose();
    }
  }

  onBulkIgnore(): void {
    const selectedRows = this.selection.selected;
    if (selectedRows.length === 0) {
      alert('Please select rows to ignore');
      return;
    }

    selectedRows.forEach(row => {
      row.mappingType = 'Null / Ignore';
      row.targetCode = '';
      row.targetLabel = '';
      row.hasWarning = false;
    });

    this.selection.clear();
    this.updateCounts();
    this.trackChange();
  }

  onBulkDefault(): void {
    const selectedRows = this.selection.selected;
    if (selectedRows.length === 0) {
      alert('Please select rows to set as default');
      return;
    }

    selectedRows.forEach(row => {
      row.mappingType = 'Default';
    });

    this.selection.clear();
    this.trackChange();
  }

  onBulkDelete(): void {
    const selectedRows = this.selection.selected;
    if (selectedRows.length === 0) {
      alert('Please select rows to delete');
      return;
    }

    if (confirm(`Delete ${selectedRows.length} selected mapping(s)?`)) {
      // Remove selected rows from data source
      this.dataSource.data = this.dataSource.data.filter(row => !this.selection.isSelected(row));
      this.selection.clear();
      this.updateCounts();
      this.trackChange();
    }
  }

  onViewExistingMapping(row: MappingRow): void {
    console.log('[MapCodeSet] View existing mapping:', row.existingMapping);
    // In production, navigate to existing mapping details
  }

  private finalizeSave(): void {
    console.log('[MapCodeSet] Saving mapping:', {
      name: this.nameControl.value,
      sourceCodeSet: this.mappingData?.sourceCodeSet,
      targetCodeSet: this.targetCodeSetControl.value,
      mappings: this.dataSource.data,
      stats: {
        total: this.totalCodes,
        mapped: this.mappedCount,
        unmapped: this.unmappedCount,
        overrides: this.overridesCount,
      },
    });

    // In real implementation, call API here
    this.eventService.publish('nf', 'code_mapping_saved', {
      action: 'code_mapping_saved',
      mappingId: this.mappingData?.id || `mapping-${Date.now()}`,
      sourceCodeSet: this.mappingData?.sourceCodeSet,
      targetCodeSet: this.targetCodeSetControl.value,
      mappedCount: this.mappedCount,
    });

    this.hasUnsavedChanges = false;
    this.executeClose();
  }

  private discardChangesAndClose(): void {
    // Revert to original
    this.dataSource.data = JSON.parse(JSON.stringify(this.originalData));
    this.hasUnsavedChanges = false;
    this.isDraft = true;
    this.updateCounts();

    // ✅ CORRECT PATTERN: Just close
    this.executeClose();
  }

  private executeClose(): void {
    this.isExiting = true;
    setTimeout(() => {
      this.closeMapping.emit();
    }, 500);
  }

  private getActiveTheme(): 'light' | 'dark' {
    const isDark =
      document.body.classList.contains('dark-theme') ||
      document.body.classList.contains('dark-mode') ||
      (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
    return isDark ? 'dark' : 'light';
  }

  // Utility getters
  get canSave(): boolean {
    return !!this.targetCodeSetControl.value && this.mappedCount > 0;
  }

  get statusBadgeClass(): string {
    return this.isDraft ? 'draft' : 'active';
  }

  get statusBadgeText(): string {
    return this.isDraft ? 'Draft' : 'Active';
  }

  get unsavedBadgeText(): string {
    return this.hasUnsavedChanges ? 'Unsaved changes' : 'All changes saved';
  }
}

then map-code-set.component.html: 
<!-- Map Code Set Component - Full Page Workspace -->
<div class="map-code-set-wrapper">
  <!-- STICKY HEADER -->
  <div class="main-header">
    <div class="header-content">
      <h1 class="page-title">Map this Code Set</h1>

      <!-- Source → Target Line -->
      <div class="source-target-line">
        <span class="source-label">Source:</span>
        <strong class="source-value">{{ mappingData?.sourceCodeSet || 'Unknown' }}</strong>
        <mat-icon class="arrow-icon">arrow_forward</mat-icon>

        <!-- Target Code Set Selector -->
        <mat-form-field appearance="outline" class="target-selector">
          <mat-select 
            [formControl]="targetCodeSetControl"
            (selectionChange)="onTargetCodeSetChange()"
            placeholder="Select Target Code Set">
            @for (codeSet of targetCodeSets; track codeSet) {
              <mat-option [value]="codeSet">{{ codeSet }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <!-- Status Badges -->
        <div class="status-badges">
          <span class="status-badge" [ngClass]="statusBadgeClass">
            <mat-icon>{{ isDraft ? 'edit' : 'check_circle' }}</mat-icon>
            {{ statusBadgeText }}
          </span>
          <span class="unsaved-badge" [class.has-changes]="hasUnsavedChanges">
            {{ unsavedBadgeText }}
          </span>
        </div>
      </div>
    </div>

    <div class="header-actions">
      <button mat-flat-button class="btn-cancel" (click)="onCancel()">
        Cancel
      </button>

      <button 
        mat-flat-button 
        class="btn-save" 
        [disabled]="!canSave"
        (click)="onSave()">
        Save Mapping
      </button>
    </div>
  </div>

  <!-- MAPPING CONTEXT & PROGRESS STRIP -->
  <div class="context-strip">
    <div class="context-left">
      <!-- Editable Name -->
      <div class="name-field">
        <label>Name:</label>
        <input 
          type="text" 
          [formControl]="nameControl"
          (blur)="trackChange()"
          class="inline-input" 
          placeholder="Enter mapping name" />
      </div>

      <!-- Optional Description (Collapsed) -->
      <button mat-button class="add-description-btn">
        <mat-icon>add</mat-icon>
        Add description
      </button>

      <!-- Coverage Indicators -->
      <div class="coverage-indicators">
        <div class="indicator success">
          <mat-icon>check_circle</mat-icon>
          <span>Mapped <strong>{{ mappedCount }}</strong> of <strong>{{ totalCodes }}</strong> codes</span>
        </div>

        @if (unmappedCount > 0) {
          <div class="indicator warning">
            <mat-icon>warning</mat-icon>
            <span><strong>{{ unmappedCount }}</strong> Unmapped remaining</span>
          </div>
        }

        @if (overridesCount > 0) {
          <div class="indicator alert">
            <mat-icon>error_outline</mat-icon>
            <span><strong>{{ overridesCount }}</strong> Overrides detected</span>
          </div>
        }
      </div>
    </div>

    <div class="context-right">
      <!-- Show Unmapped Toggle -->
      <mat-slide-toggle 
        [formControl]="showUnmappedControl"
        class="show-unmapped-toggle">
        Show Unmapped
      </mat-slide-toggle>
    </div>
  </div>

  <!-- MAIN CONTENT GRID -->
  <div class="main-content-grid">
    <!-- LEFT: Mapping Table Section -->
    <section class="table-section">
      <!-- Table Controls -->
      <div class="table-controls">
        <button 
          mat-flat-button 
          class="bulk-action-btn"
          [disabled]="selection.selected.length === 0"
          [matMenuTriggerFor]="bulkMenu">
          <mat-icon>more_horiz</mat-icon>
          Bulk Actions
        </button>

        <mat-menu #bulkMenu="matMenu">
          <button mat-menu-item (click)="onBulkIgnore()">
            <mat-icon>block</mat-icon>
            <span>Set to Null / Ignore</span>
          </button>
          <button mat-menu-item (click)="onBulkDefault()">
            <mat-icon>label</mat-icon>
            <span>Set to Default</span>
          </button>
          <mat-divider></mat-divider>
          <button mat-menu-item class="danger-action" (click)="onBulkDelete()">
            <mat-icon>delete_outline</mat-icon>
            <span>Delete Selected</span>
          </button>
        </mat-menu>
      </div>

      <!-- Table Wrapper (no scroll - paginator handles it) -->
      <div class="table-wrapper">
        <table 
          mat-table 
          [dataSource]="dataSource"
          matSort
          class="mapping-table">

          <!-- Select Column -->
          <ng-container matColumnDef="select">
            <th mat-header-cell *matHeaderCellDef class="col-select">
              <mat-checkbox
                [checked]="isAllSelected()"
                [indeterminate]="isSomeSelected()"
                (change)="masterToggle()">
              </mat-checkbox>
            </th>
            <td mat-cell *matCellDef="let row" class="col-select">
              <mat-checkbox
                [checked]="selection.isSelected(row)"
                (change)="selection.toggle(row)"
                (click)="$event.stopPropagation()">
              </mat-checkbox>
            </td>
          </ng-container>

          <!-- Source Code Column -->
          <ng-container matColumnDef="sourceCode">
            <th mat-header-cell *matHeaderCellDef mat-sort-header class="col-source-code">
              SOURCE CODE
            </th>
            <td mat-cell *matCellDef="let row" class="col-source-code">
              <span class="code-value">{{ row.sourceCode }}</span>
            </td>
          </ng-container>

          <!-- Source Label Column -->
          <ng-container matColumnDef="sourceLabel">
            <th mat-header-cell *matHeaderCellDef mat-sort-header class="col-source-label">
              SOURCE LABEL
            </th>
            <td mat-cell *matCellDef="let row" class="col-source-label">
              {{ row.sourceLabel }}
            </td>
          </ng-container>

          <!-- Target Code Column -->
          <ng-container matColumnDef="targetCode">
            <th mat-header-cell *matHeaderCellDef class="col-target-code">
              TARGET CODE
            </th>
            <td mat-cell *matCellDef="let row" class="col-target-code">
              <mat-form-field appearance="outline" class="inline-select">
                <mat-select 
                  [(value)]="row.targetCode"
                  (selectionChange)="onTargetCodeChange(row, $event)"
                  [disabled]="!targetCodeSetControl.value || row.mappingType === 'Null / Ignore'"
                  placeholder="Select code">
                  @for (target of availableTargetCodes; track target.code) {
                    <mat-option [value]="target.code">
                      {{ target.code }}
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </td>
          </ng-container>

          <!-- Target Label Column -->
          <ng-container matColumnDef="targetLabel">
            <th mat-header-cell *matHeaderCellDef class="col-target-label">
              TARGET LABEL
            </th>
            <td mat-cell *matCellDef="let row" class="col-target-label">
              <span class="target-label-text">{{ row.targetLabel || '—' }}</span>
            </td>
          </ng-container>

          <!-- Mapping Type Column -->
          <ng-container matColumnDef="mappingType">
            <th mat-header-cell *matHeaderCellDef class="col-mapping-type">
              MAPPING TYPE
            </th>
            <td mat-cell *matCellDef="let row" class="col-mapping-type">
              <mat-form-field appearance="outline" class="inline-select">
                <mat-select 
                  [(value)]="row.mappingType"
                  (selectionChange)="onMappingTypeChange(row, $event)">
                  @for (type of mappingTypeOptions; track type) {
                    <mat-option [value]="type">{{ type }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef class="col-status">
              STATUS
            </th>
            <td mat-cell *matCellDef="let row" class="col-status">
              @if (row.hasWarning) {
                <button 
                  mat-icon-button 
                  class="warning-icon"
                  [matTooltip]="row.warningMessage || 'Warning'"
                  (click)="onRowClick(row); $event.stopPropagation()">
                  <mat-icon>warning</mat-icon>
                </button>
              }
            </td>
          </ng-container>

          <!-- Header & Row Definitions -->
          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
          <tr 
            mat-row 
            *matRowDef="let row; columns: displayedColumns"
            [class.has-warning]="row.hasWarning"
            [class.selected]="selection.isSelected(row)"
            [class.active-warning]="selectedRow?.id === row.id"
            (click)="onRowClick(row)">
          </tr>
        </table>
      </div>

      <!-- PAGINATOR - placed here like edit-mapping -->
      <div class="table-footer">
        <mat-paginator
          [pageSizeOptions]="[5, 10, 20, 50]"
          [pageSize]="5"
          [length]="dataSource.data.length"
          showFirstLastButtons
          aria-label="Select page of mappings">
        </mat-paginator>
      </div>
    </section>

    <!-- RIGHT: Progress & Warnings Rail -->
    <div class="right-rail">
      <!-- Coverage Progress Block -->
      <div class="rail-block progress-block">
        <h3 class="block-title">Coverage Progress</h3>

        <!-- Progress Bar -->
        <mat-progress-bar 
          [value]="mappingProgress"
          [color]="progressBarColor"
          mode="determinate"
          class="coverage-progress-bar">
        </mat-progress-bar>

        <!-- Stats -->
        <div class="progress-stats">
          <div class="stat-row">
            <span class="stat-label">Mapped</span>
            <span class="stat-value primary">{{ mappedCount }} / {{ totalCodes }}</span>
          </div>
          @if (unmappedCount > 0) {
            <div class="stat-row">
              <span class="stat-label">Unmapped</span>
              <span class="stat-value warning">{{ unmappedCount }}</span>
            </div>
          }
        </div>

        <!-- Status Label -->
        <div class="progress-status">
          @if (mappingProgress === 0) {
            <span class="status-label not-started">Not started</span>
          } @else if (mappingProgress < 100) {
            <span class="status-label in-progress">In progress</span>
          } @else {
            <span class="status-label complete">
              <mat-icon>check_circle</mat-icon>
              Complete
            </span>
          }
        </div>
      </div>

      <!-- Override Warnings Block -->
      @if (overridesCount > 0) {
        <div class="rail-block warnings-block">
          <div class="block-header">
            <mat-icon class="warning-icon">warning</mat-icon>
            <h3 class="block-title">Override Warnings</h3>
          </div>

          <p class="warning-description">
            <strong>{{ overridesCount }}</strong> Existing mappings overridden
          </p>

          <p class="warning-explanation">
            These mappings override existing Code Set or Code-level mappings
          </p>

          <!-- Selected Row Warning Detail -->
          @if (selectedRow && selectedRow.hasWarning) {
            <div class="active-warning-detail">
              <div class="warning-title">
                <mat-icon>error_outline</mat-icon>
                <strong>Override detected</strong>
              </div>

              <p class="warning-message">
                This code already maps via {{ selectedRow.existingMapping?.type || 'another mapping' }} 
                → {{ selectedRow.existingMapping?.targetCode || 'LOINC' }}.
              </p>

              <p class="warning-impact">
                This mapping will take precedence.
              </p>

              <button 
                mat-button 
                class="view-existing-link"
                (click)="onViewExistingMapping(selectedRow)">
                View existing mapping
                <mat-icon>arrow_forward</mat-icon>
              </button>
            </div>
          }
        </div>
      }
    </div>
  </div>

  <!-- BOTTOM ACTIONS (Optional Secondary Save) -->
  <div class="bottom-actions">
    <button mat-flat-button class="btn-cancel" (click)="onCancel()">
      Cancel
    </button>

    <button 
      mat-flat-button 
      class="btn-save" 
      [disabled]="!canSave"
      (click)="onSave()">
      Save Mapping
    </button>
  </div>
</div> - this fails to display payload when it's sent from modal, not from normalization.compinent.
Then below is (base) ➜  graph-db-frontend-new git:(devel-0.0.2) ✗ cat src/app/shared/components/new-code-set-modal/new-code-set-modal.component.ts
import { Component, effect, OnDestroy, OnInit, signal } from '@angular/core';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';
import { EventService } from '@modules/events/services/event.service';
import { EventState } from '@modules/events/states/event.state';
import { Store } from '@ngrx/store';
import { Subscription } from 'rxjs';

export interface CodeEntry {
  codeValue: string;
  label: string;
  description?: string;
  status: string;
}

@Component({
  selector: 'app-new-code-set-modal',
  standalone: false,
  templateUrl: './new-code-set-modal.component.html',
  styleUrls: ['./new-code-set-modal.component.scss'],
  providers: [EventService],
})
export class NewCodeSetModalComponent implements OnInit, OnDestroy {
  // Signals for state management
  public isOpen = signal<boolean>(false);
  public theme = signal<'light' | 'dark'>('light');
  public showAddCodeModal = signal<boolean>(false);
  public activeStep = signal<number>(0);
  public reviewSnapshot = signal<any>(null);

  // Step indicator states
  public step1Complete = signal<boolean>(false);
  public step2Complete = signal<boolean>(false);
  public step3Complete = signal<boolean>(false);
  public step4Complete = signal<boolean>(false);

  // Codes management
  public codesArray = signal<CodeEntry[]>([]);
  public addCodesNow = signal<boolean>(true);

  // Step 5: Created code set data
  public createdCodeSetId = signal<string | null>(null);
  public createdCodeSetName = signal<string>('');
  public createdCodeSetData = signal<any>(null);

  // Dynamic Metadata Signals (for future compatibility)
  public systems = signal<string[]>([]);
  public statuses = signal<string[]>([]);

  private eventSubs?: Subscription;

  // Step Forms
  basicsForm!: FormGroup;
  semanticsForm!: FormGroup;
  structureForm!: FormGroup;

  // Dropdown options
  meaningTypes = [
    'Enumerated categories (e.g., status, type)',
    'Ordinal (ordered values)',
    'Classification / taxonomy',
    'Identifier / reference',
  ];

  canonicalReps = ['Code only (e.g., A1)', 'Code + label (e.g., A1 – Active)', 'Label only'];

  codeValueTypes = ['String', 'Integer', 'Alphanumeric'];

  constructor(
    private _fb: FormBuilder,
    protected eventService: EventService,
    private eventStore: Store<{ nf: EventState }>,
  ) {
    effect(() => {
      console.log(`[CodeSet Modal] Theme: ${this.theme()}, Step: ${this.activeStep()}`);
    });
  }

  ngOnInit(): void {
    this.initForms();
    this.subscribeToEvents();
  }

  private initForms() {
    // Step 1: Basics
    this.basicsForm = this._fb.group({
      name: ['', Validators.required],
      description: [''],
      codeSystem: [''],
      severity: ['Critical', Validators.required],
    });

    // Step 2: Semantics
    this.semanticsForm = this._fb.group({
      meaningType: ['', Validators.required],
      canonicalRepresentation: ['', Validators.required],
      extensible: ['yes', Validators.required],
      deprecatedAllowed: [false],
    });

    // Step 3: Structure
    this.structureForm = this._fb.group({
      codeValueType: ['', Validators.required],
      uniquenessScope: ['local', Validators.required],
    });
  }

  private subscribeToEvents() {
    this.eventSubs = this.eventStore.select('nf').subscribe((state: any) => {
      // 1. Safeguard: Check if state or items exist
      if (!state || !state.items) return;

      const itemEvent = state.items.event;
      const payload = state.items.payload;

      // --- Main Modal Open ---
      if (
        ['open_new_code_set_modal', 'open_new_value_set_modal'].includes(itemEvent) ||
        ['open_new_code_set_modal', 'open_new_value_set_modal'].includes(payload?.action)
      ) {
        this.theme.set(payload?.theme || this.getActiveTheme());

        if (payload?.defaults) {
          this.basicsForm.patchValue(payload.defaults);
        }

        this.isOpen.set(true);
        this.activeStep.set(0);
      }

      // --- Add Code Success (The payload listener) ---
      if (itemEvent === 'code_added_to_set' || payload?.action === 'code_added_to_set') {
        if (payload?.code) {
          this.codesArray.update(currentCodes => [...currentCodes, payload.code]);
          console.log('[Parent] Code added to list:', payload.code);
        }
        this.showAddCodeModal.set(false);
      }

      // --- Add Code Modal Close ---
      if (itemEvent === 'close_add_code_modal' || payload?.action === 'close_add_code_modal') {
        this.showAddCodeModal.set(false);
      }

      // --- Final Save Confirmation ---
      if (
        itemEvent === 'confirmation_save_confirmed' ||
        payload?.action === 'confirmation_save_confirmed'
      ) {
        // MATCHED: Checking for 'save' command as sent by confirmCreate()
        if (payload?.command === 'save' && payload?.confirmed) {
          this.executeFinalSave();
        }
      }

      // --- Main Modal Close ---
      if (
        ['close_new_code_set_modal', 'close_new_value_set_modal'].includes(itemEvent) ||
        ['close_new_code_set_modal', 'close_new_value_set_modal'].includes(payload?.action)
      ) {
        //this.handleInternalClose();
      }
    });
  }

  nextStep() {
    const currentStep = this.activeStep();

    if (currentStep === 0 && this.basicsForm.valid) {
      this.step1Complete.set(true);
      this.activeStep.set(1);
    } else if (currentStep === 1 && this.semanticsForm.valid) {
      this.step2Complete.set(true);
      this.activeStep.set(2);
    } else if (currentStep === 2 && this.structureForm.valid) {
      this.step3Complete.set(true);
      this.captureReviewSnapshot();
      this.activeStep.set(3);
    } else if (currentStep === 3) {
      // FROM REVIEW, GO TO CREATE - triggers confirmCreate
      this.confirmCreate();
    } else if (currentStep === 4) {
      // FROM CONNECT STEP, CLOSE MODAL
      this.finishWithoutConnecting();
    }
  }

  prevStep() {
    const currentStep = this.activeStep();
    if (currentStep > 0) {
      this.activeStep.set(currentStep - 1);
    }
  }

  goToStep(step: number) {
    if (
      step === 0 ||
      (step === 1 && this.step1Complete()) ||
      (step === 2 && this.step2Complete()) ||
      (step === 3 && this.step3Complete()) ||
      (step === 4 && this.step4Complete())
    ) {
      this.activeStep.set(step);
    }
  }

  private captureReviewSnapshot() {
    const snapshot = {
      basics: {
        name: this.basicsForm.get('name')?.value,
        description: this.basicsForm.get('description')?.value,
        codeSystem: this.basicsForm.get('codeSystem')?.value,
        severity: this.basicsForm.get('severity')?.value,
      },
      semantics: {
        meaningType: this.semanticsForm.get('meaningType')?.value,
        canonicalRepresentation: this.semanticsForm.get('canonicalRepresentation')?.value,
        extensible: this.semanticsForm.get('extensible')?.value,
        deprecatedAllowed: this.semanticsForm.get('deprecatedAllowed')?.value,
      },
      structure: {
        codeValueType: this.structureForm.get('codeValueType')?.value,
        uniquenessScope: this.structureForm.get('uniquenessScope')?.value,
      },
      codes: this.codesArray(),
    };
    this.reviewSnapshot.set(snapshot);
  }

  public openAddCodeModal() {
    const codeSetData = {
      name: this.basicsForm.get('name')?.value || 'New Code Set',
      codeValueType: this.structureForm.get('codeValueType')?.value,
      uniquenessScope: this.structureForm.get('uniquenessScope')?.value,
      existingCodes: this.codesArray(),
      deprecatedAllowed: this.semanticsForm.get('deprecatedAllowed')?.value,
    };

    this.eventService.publish('nf', 'open_add_new_code_modal', {
      action: 'open_add_new_code_modal',
      codeSetData: codeSetData,
      theme: this.theme(),
    });

    this.showAddCodeModal.set(true);
  }

  removeCode(index: number) {
    const currentCodes = this.codesArray();
    this.codesArray.set(currentCodes.filter((_, i) => i !== index));
  }

  public close() {
    // Aligned with NewModelModalComponent: Notify store before closing internally
    this.eventService.publish('nf', 'close_new_code_set_modal', {
      action: 'close_new_code_set_modal',
      theme: this.theme(),
    });
    this.handleInternalClose();
  }

  public confirmCreate() {
    if (this.basicsForm.invalid || this.semanticsForm.invalid || this.structureForm.invalid) {
      return;
    }

    this.eventService.publish('nf', 'open_confirmation_modal', {
      action: 'open_confirmation_modal',
      title: 'Confirm Code Set Creation',
      message: `Are you sure you want to create the code set "${this.basicsForm.get('name')?.value}"?`,
      command: 'save',
      itemName: this.basicsForm.get('name')?.value,
      theme: this.theme(),
    });
  }

  private executeFinalSave() {
    const payload = {
      basics: this.basicsForm.value,
      semantics: this.semanticsForm.value,
      structure: this.structureForm.value,
      codes: this.codesArray(),
      attribution: {
        createdBy: 'Current User',
        timestamp: new Date().toISOString(),
      },
      theme: this.theme(),
    };

    // Generate mock ID for the created code set
    const codeSetId = `cs_${Date.now()}`;
    const codeSetName = this.basicsForm.get('name')?.value;

    // Store created code set data
    this.createdCodeSetId.set(codeSetId);
    this.createdCodeSetName.set(codeSetName);
    this.createdCodeSetData.set(payload);

    this.eventService.publish('nf', 'code_set_creation_complete', {
      action: 'code_set_creation_complete',
      payload: payload,
      codeSetId: codeSetId,
      codeSetName: codeSetName,
    });

    console.log('[CODE SET] Created:', payload);

    // Mark step 4 complete and navigate to Step 5 (Connect)
    this.step4Complete.set(true);
    this.activeStep.set(4);

    // DO NOT close the modal - user sees Step 5
  }

  /**
   * Opens Map Code Set component from newly created code set
   * Uses EXACT format from normalization.component.ts generateSourceCodeRows
   */
  public createMappingWithCodeSet() {
    console.log('[NewCodeSetModal] Opening Map Code Set with', this.codesArray().length, 'codes');
    
    // Transform codesArray into sourceCodeRows with EXACT property names
    const sourceCodeRows = this.codesArray().map((code) => ({
      sourceCode: code.codeValue,
      sourceLabel: code.label,
      targetCode: '',
      targetLabel: '',
      mappingType: 'Direct',
      hasWarning: false,
    }));

    // Prepare mapping data in EXACT format from normalization.component.ts
    const mappingData = {
      id: this.createdCodeSetId(),
      sourceCodeSet: this.createdCodeSetName(),
      targetCodeSet: '',
      sourceCodeRows: sourceCodeRows,
    };

    console.log('[NewCodeSetModal] Mapping data:', {
      sourceCodeSet: mappingData.sourceCodeSet,
      rowCount: sourceCodeRows.length,
      firstRow: sourceCodeRows[0],
    });

    // Close this modal AFTER user clicks "Map Code Set"
    this.handleInternalClose();

    // Publish event to open Map Code Set (same as Codes tab)
    this.eventService.publish('nf', 'open_map_code_set', {
      action: 'open_map_code_set',
      codeSetId: this.createdCodeSetId(),
      fullData: mappingData,
    });

    // Update breadcrumb
    const breadcrumbPath = [
      { label: 'Normalization', target: 'ROOT' },
      { label: 'Codes', target: 'TAB_CODES' },
      { label: `Map: ${this.createdCodeSetName()}`, target: 'MAP_CODE_SET', active: true },
    ];
    this.eventService.publish('nf', 'update_breadcrumb', { path: breadcrumbPath });
  }

  /**
   * Opens the Create New Validation Rule modal with the newly created code set pre-selected
   */
  public createValidationRuleForCodeSet() {
    const codeSetData = {
      id: this.createdCodeSetId(),
      name: this.createdCodeSetName(),
      system: this.basicsForm.get('codeSystem')?.value,
      codeValueType: this.structureForm.get('codeValueType')?.value,
      codes: this.codesArray(),
    };

    // Close this modal first
    this.handleInternalClose();
    // Open the new validation rule modal with code set pre-selected
    this.eventService.publish('nf', 'open_new_code_set_validation_rule_modal', {
      action: 'open_new_code_set_validation_rule_modal',
      codeSetData: codeSetData,
      preselectedCodeSet: {
        id: this.createdCodeSetId(),
        name: this.createdCodeSetName(),
      },
      theme: this.theme(),
    });
  }

  /**
   * Opens the code set detail view in the same context
   */
  public viewCodeSetDetails() {
    const codeSetData = {
      id: this.createdCodeSetId(),
      name: this.createdCodeSetName(),
      ...this.createdCodeSetData(),
    };

    // Publish event to open code set detail panel
    this.eventService.publish('nf', 'open_code_set_detail', {
      action: 'open_code_set_detail',
      codeSetId: this.createdCodeSetId(),
      codeSetData: codeSetData,
    });

    // Close modal
    this.handleInternalClose();
  }

  /**
   * User chooses "Not now" - just close the modal
   */
  public finishWithoutConnecting() {
    // Just close the modal - code set is already created
    this.handleInternalClose();
  }

  private handleInternalClose() {
    this.isOpen.set(false);
    this.activeStep.set(0);
    this.resetModalState();
  }

  private resetModalState() {
    this.activeStep.set(0);
    this.step1Complete.set(false);
    this.step2Complete.set(false);
    this.step3Complete.set(false);
    this.step4Complete.set(false);
    this.reviewSnapshot.set(null);
    this.codesArray.set([]);
    this.addCodesNow.set(true);

    // Reset Step 5 data
    this.createdCodeSetId.set(null);
    this.createdCodeSetName.set('');
    this.createdCodeSetData.set(null);

    this.basicsForm.reset({ severity: 'Critical' });
    this.semanticsForm.reset({ extensible: 'yes', deprecatedAllowed: false });
    this.structureForm.reset({ uniquenessScope: 'local' });
  }

  private getActiveTheme(): 'light' | 'dark' {
    return document.body.classList.contains('dark-theme') ? 'dark' : 'light';
  }

  ngOnDestroy(): void {
    if (this.eventSubs) {
      this.eventSubs.unsubscribe();
    }
  }
}%                                                                                                                                                                                 (base) ➜  graph-db-frontend-new git:(devel-0.0.2) ✗ cat src/app/shared/components/new-code-set-modal/new-code-set-modal.component.html 
@if (isOpen()) {
  <div class="modal-overlay" (click)="close()">
    <div
      class="modal-container"
      [class.dark]="theme() === 'dark'"
      [class.light]="theme() === 'light'"
      (click)="$event.stopPropagation()">
      <header
        class="modal-header"
        [class.dark]="theme() === 'dark'"
        [class.light]="theme() === 'light'">
        <div class="header-title">
          <h2>Create New Code Set</h2>
        </div>
        <button mat-icon-button (click)="close()">
          <mat-icon>close</mat-icon>
        </button>
      </header>

      <div
        class="stepper-nav"
        [class.dark]="theme() === 'dark'"
        [class.light]="theme() === 'light'">
        <div
          class="step-item"
          [class.active]="activeStep() === 0"
          [class.completed]="step1Complete()"
          (click)="goToStep(0)">
          <div class="step-circle">
            @if (step1Complete() && activeStep() !== 0) {
              <mat-icon>check</mat-icon>
            } @else {
              <span>1</span>
            }
          </div>
          <span class="step-label">Basics</span>
        </div>

        <div
          class="step-item"
          [class.active]="activeStep() === 1"
          [class.completed]="step2Complete()"
          [class.disabled]="!step1Complete()"
          (click)="goToStep(1)">
          <div class="step-circle">
            @if (step2Complete() && activeStep() !== 1) {
              <mat-icon>check</mat-icon>
            } @else {
              <span>2</span>
            }
          </div>
          <span class="step-label">Semantics</span>
        </div>

        <div
          class="step-item"
          [class.active]="activeStep() === 2"
          [class.completed]="step3Complete()"
          [class.disabled]="!step2Complete()"
          (click)="goToStep(2)">
          <div class="step-circle">
            @if (step3Complete() && activeStep() !== 2) {
              <mat-icon>check</mat-icon>
            } @else {
              <span>3</span>
            }
          </div>
          <span class="step-label">Structure</span>
        </div>

        <div
          class="step-item"
          [class.active]="activeStep() === 3"
          [class.completed]="step4Complete()"
          [class.disabled]="!step3Complete()"
          (click)="goToStep(3)">
          <div class="step-circle">
            @if (step4Complete() && activeStep() !== 3) {
              <mat-icon>check</mat-icon>
            } @else {
              <span>4</span>
            }
          </div>
          <span class="step-label">Review</span>
        </div>

        <div
          class="step-item"
          [class.active]="activeStep() === 4"
          [class.disabled]="!step4Complete()"
          (click)="goToStep(4)">
          <div class="step-circle">
            <span>5</span>
          </div>
          <span class="step-label">Next Steps</span>
        </div>
      </div>

      <div
        class="step-content-wrapper"
        [class.dark]="theme() === 'dark'"
        [class.light]="theme() === 'light'">
        
        <!-- STEP 1: BASICS -->
        @if (activeStep() === 0) {
          <div class="step-content">
            <p class="step-description">Define what this code set represents and why it exists.</p>

            <form [formGroup]="basicsForm">
              <mat-form-field
                appearance="outline"
                [class.dark-field]="theme() === 'dark'"
                [class.light-field]="theme() === 'light'">
                <mat-label>Code Set Name</mat-label>
                <input
                  matInput
                  formControlName="name"
                  placeholder="e.g., Employment Status Codes" />
                <mat-hint>Used to identify this code set across rules and mappings.</mat-hint>
              </mat-form-field>

              <mat-form-field
                appearance="outline"
                [class.dark-field]="theme() === 'dark'"
                [class.light-field]="theme() === 'light'">
                <mat-label>Description</mat-label>
                <textarea
                  matInput
                  formControlName="description"
                  rows="3"
                  placeholder="Describe what these codes represent and when they should be used."></textarea>
              </mat-form-field>

              <mat-form-field
                appearance="outline"
                [class.dark-field]="theme() === 'dark'"
                [class.light-field]="theme() === 'light'">
                <mat-label>Code System / Authority</mat-label>
                <input
                  matInput
                  formControlName="codeSystem"
                  placeholder="e.g., Internal, ISO, NAICS, HL7" />
                <mat-hint>Identifies the source or authority that defines these codes.</mat-hint>
              </mat-form-field>

              <div
                class="severity-section"
                [class.dark]="theme() === 'dark'"
                [class.light]="theme() === 'light'">
                <label class="severity-label"
                  >Severity / Criticality <span class="required-asterisk">*</span></label
                >

                <mat-radio-group
                  formControlName="severity"
                  class="severity-grid"
                  [class.dark-radio]="theme() === 'dark'"
                  [class.light-radio]="theme() === 'light'">
                  <div class="severity-option">
                    <mat-radio-button value="Critical">
                      <span class="severity-title">Critical</span>
                    </mat-radio-button>
                    <span class="severity-desc">Misuse breaks semantic integrity</span>
                  </div>

                  <div class="severity-option">
                    <mat-radio-button value="High">
                      <span class="severity-title">High</span>
                    </mat-radio-button>
                    <span class="severity-desc">Significant downstream impact</span>
                  </div>

                  <div class="severity-option">
                    <mat-radio-button value="Medium">
                      <span class="severity-title">Medium</span>
                    </mat-radio-button>
                    <span class="severity-desc">Moderate normalization impact</span>
                  </div>

                  <div class="severity-option">
                    <mat-radio-button value="Low">
                      <span class="severity-title">Low</span>
                    </mat-radio-button>
                    <span class="severity-desc">Informational / helper set</span>
                  </div>
                </mat-radio-group>
              </div>
            </form>
          </div>

          <div
            class="step-footer-actions"
            [class.dark]="theme() === 'dark'"
            [class.light]="theme() === 'light'">
            <div></div>
            <button
              mat-flat-button
              class="next-btn"
              (click)="nextStep()"
              [disabled]="basicsForm.invalid">
              Next
            </button>
          </div>
        }

        <!-- STEP 2: SEMANTICS -->
        @if (activeStep() === 1) {
          <div class="step-content">
            <p class="step-description">
              Establish semantic rules that apply to all codes in the set.
            </p>

            <form [formGroup]="semanticsForm">
              <mat-form-field
                appearance="outline"
                [class.dark-field]="theme() === 'dark'"
                [class.light-field]="theme() === 'light'">
                <mat-label>Code Meaning Type</mat-label>
                <mat-select formControlName="meaningType" placeholder="Select a meaning type">
                  @for (type of meaningTypes; track type) {
                    <mat-option [value]="type">{{ type }}</mat-option>
                  }
                </mat-select>
                <mat-hint
                  >Defines the semantic function of all individual codes within this set.</mat-hint
                >
              </mat-form-field>

              <mat-form-field
                appearance="outline"
                [class.dark-field]="theme() === 'dark'"
                [class.light-field]="theme() === 'light'">
                <mat-label>Canonical Representation</mat-label>
                <mat-select
                  formControlName="canonicalRepresentation"
                  placeholder="Select a representation type">
                  @for (rep of canonicalReps; track rep) {
                    <mat-option [value]="rep">{{ rep }}</mat-option>
                  }
                </mat-select>
                <mat-hint
                  >Determines how codes are labeled, depicted, stored, and exported.</mat-hint
                >
              </mat-form-field>

              <div
                class="severity-section"
                [class.dark]="theme() === 'dark'"
                [class.light]="theme() === 'light'">
                <label class="severity-label"
                  >Is this Code Set extensible? <span class="required-asterisk">*</span></label
                >

                <mat-radio-group
                  formControlName="extensible"
                  class="severity-grid"
                  [class.dark-radio]="theme() === 'dark'"
                  [class.light-radio]="theme() === 'light'">
                  <div class="severity-option">
                    <mat-radio-button value="yes">
                      <span class="severity-title">Yes — new codes may be added over time</span>
                    </mat-radio-button>
                  </div>

                  <div class="severity-option">
                    <mat-radio-button value="no">
                      <span class="severity-title">No — closed / fixed list</span>
                    </mat-radio-button>
                  </div>
                </mat-radio-group>
                <span class="step-description"
                  >Defines if other codes can be added to this set in the future.</span
                >
              </div>

              <div
                class="info-callout"
                [class.dark]="theme() === 'dark'"
                [class.light]="theme() === 'light'">
                <mat-checkbox formControlName="deprecatedAllowed">
                  Allow codes in this set to be marked as deprecated
                </mat-checkbox>
                <p>Controls whether codes can later be marked inactive.</p>
              </div>
            </form>
          </div>

          <div
            class="step-footer-actions"
            [class.dark]="theme() === 'dark'"
            [class.light]="theme() === 'light'">
            <button
              mat-flat-button
              class="back-btn"
              [class.dark]="theme() === 'dark'"
              [class.light]="theme() === 'light'"
              (click)="prevStep()">
              Back
            </button>
            <button
              mat-flat-button
              class="next-btn"
              (click)="nextStep()"
              [disabled]="semanticsForm.invalid">
              Next
            </button>
          </div>
        }

        <!-- STEP 3: STRUCTURE -->
        @if (activeStep() === 2) {
          <div class="step-content">
            <p class="step-description">
              Define required fields and constraints for individual codes within this set.
            </p>

            <form [formGroup]="structureForm">
              <mat-form-field
                appearance="outline"
                [class.dark-field]="theme() === 'dark'"
                [class.light-field]="theme() === 'light'">
                <mat-label>Code Value Type</mat-label>
                <mat-select formControlName="codeValueType" placeholder="Select a value type">
                  @for (type of codeValueTypes; track type) {
                    <mat-option [value]="type">{{ type }}</mat-option>
                  }
                </mat-select>
                <mat-hint>Constrains the valid format of codes in this set.</mat-hint>
              </mat-form-field>

              <div class="form-field-group">
                <label class="group-label"
                  >Code Uniqueness Scope <span class="required-asterisk">*</span></label
                >
                <mat-radio-group
                  formControlName="uniquenessScope"
                  class="radio-group-horizontal"
                  [class.dark]="theme() === 'dark'"
                  [class.light]="theme() === 'light'">
                  <mat-radio-button value="local">
                    <span class="radio-label">Unique within this Code Set</span>
                    <span class="radio-hint">No duplicates allowed in this set</span>
                  </mat-radio-button>

                  <mat-radio-button value="global">
                    <span class="radio-label">Globally unique</span>
                    <span class="radio-hint">Workspace-wide uniqueness</span>
                  </mat-radio-button>
                </mat-radio-group>
              </div>

              <div style="margin-top: 32px">
                <label class="severity-label">Code Population Strategy</label>
                <div class="toggle-container" [class.light]="theme() === 'light'">
                  <button
                    type="button"
                    class="toggle-button"
                    [class.active]="addCodesNow()"
                    (click)="addCodesNow.set(true)">
                    Add codes now
                  </button>
                  <button
                    type="button"
                    class="toggle-button"
                    [class.active]="!addCodesNow()"
                    (click)="addCodesNow.set(false)">
                    Create empty code set
                  </button>
                </div>

                @if (addCodesNow()) {
                  <div class="codes-table" [class.light]="theme() === 'light'">
                    <div class="table-header">
                      <div class="col-value">
                        CODE VALUE <span class="required-asterisk">*</span>
                      </div>
                      <div class="col-label">LABEL <span class="required-asterisk">*</span></div>
                      <div class="col-desc">DESCRIPTION</div>
                      <div class="col-status">STATUS</div>
                      <div class="col-actions"></div>
                    </div>

                    <div class="table-body">
                      @if (codesArray().length > 0) {
                        @for (code of codesArray(); track $index) {
                          <div class="table-row">
                            <div class="col-value">{{ code.codeValue }}</div>
                            <div class="col-label">{{ code.label }}</div>
                            <div class="col-desc">{{ code.description || '—' }}</div>
                            <div class="col-status">
                              <span class="code-status active">{{ code.status }}</span>
                            </div>
                            <div class="col-actions">
                              <button
                                class="trash-btn"
                                mat-icon-button
                                (click)="removeCode($index)"
                                type="button">
                                <mat-icon>delete_outline</mat-icon>
                              </button>
                            </div>
                          </div>
                        }
                      } @else {
                        <div class="empty-state">
                          <mat-icon>code</mat-icon>
                          <p>No codes added yet. Click "Add Code" to start.</p>
                        </div>
                      }
                    </div>

                    <div class="table-footer">
                      <button
                        class="add-code-btn"
                        mat-button
                        (click)="openAddCodeModal()"
                        type="button">
                        <mat-icon>add</mat-icon> Add Code
                      </button>
                    </div>
                  </div>
                }
              </div>
            </form>
          </div>

          <div
            class="step-footer-actions"
            [class.dark]="theme() === 'dark'"
            [class.light]="theme() === 'light'">
            <button mat-flat-button class="back-btn" (click)="prevStep()">Back</button>
            <button
              mat-flat-button
              class="next-btn"
              (click)="nextStep()"
              [disabled]="structureForm.invalid">
              Next
            </button>
          </div>
        }

        <!-- STEP 4: REVIEW -->
        @if (activeStep() === 3 && reviewSnapshot()) {
          <div class="step-content">
            <p class="step-description">
              Review and confirm the configuration details before creating the new code set.
            </p>

            <div
              class="review-section"
              [class.dark]="theme() === 'dark'"
              [class.light]="theme() === 'light'">
              <div class="review-header">
                <mat-icon>info_outline</mat-icon>
                <h3>Basics</h3>
              </div>

              <div class="review-grid">
                <div class="review-item">
                  <span class="review-label">Code Set Name</span>
                  <span class="review-value">{{ reviewSnapshot().basics.name }}</span>
                </div>
                <div class="review-item">
                  <span class="review-label">Severity</span>
                  <span class="review-value">{{ reviewSnapshot().basics.severity }}</span>
                </div>
                <div class="review-item full-width">
                  <span class="review-label">Description</span>
                  <span class="review-value">{{
                    reviewSnapshot().basics.description || 'N/A'
                  }}</span>
                </div>
                <div class="review-item full-width">
                  <span class="review-label">Code System / Authority</span>
                  <span class="review-value">{{
                    reviewSnapshot().basics.codeSystem || 'N/A'
                  }}</span>
                </div>
              </div>
            </div>

            <div
              class="review-section"
              [class.dark]="theme() === 'dark'"
              [class.light]="theme() === 'light'">
              <div class="review-header">
                <mat-icon>category</mat-icon>
                <h3>Semantics</h3>
              </div>

              <div class="review-grid">
                <div class="review-item">
                  <span class="review-label">Code Meaning Type</span>
                  <span class="review-value">{{ reviewSnapshot().semantics.meaningType }}</span>
                </div>
                <div class="review-item">
                  <span class="review-label">Canonical Representation</span>
                  <span class="review-value">{{
                    reviewSnapshot().semantics.canonicalRepresentation
                  }}</span>
                </div>
                <div class="review-item">
                  <span class="review-label">Extensibility</span>
                  <span class="review-value">{{
                    reviewSnapshot().semantics.extensible === 'yes'
                      ? 'Yes - new codes may be added'
                      : 'No - Fixed set'
                  }}</span>
                </div>
                <div class="review-item">
                  <span class="review-label">Deprecated Codes Allowed</span>
                  <span class="review-value">{{
                    reviewSnapshot().semantics.deprecatedAllowed ? 'Yes' : 'No'
                  }}</span>
                </div>
              </div>
            </div>

            <div
              class="review-section"
              [class.dark]="theme() === 'dark'"
              [class.light]="theme() === 'light'">
              <div class="review-header">
                <mat-icon>account_tree</mat-icon>
                <h3>Structure</h3>
              </div>

              <div class="review-grid">
                <div class="review-item">
                  <span class="review-label">Code Value Type</span>
                  <span class="review-value">{{ reviewSnapshot().structure.codeValueType }}</span>
                </div>
                <div class="review-item">
                  <span class="review-label">Uniqueness Scope</span>
                  <span class="review-value">{{
                    reviewSnapshot().structure.uniquenessScope === 'local'
                      ? 'Unique within this Code Set'
                      : 'Globally unique'
                  }}</span>
                </div>
                <div class="review-item">
                  <span class="review-label">Initial Codes</span>
                  <span class="review-value">{{ reviewSnapshot().codes.length }} code(s)</span>
                </div>
              </div>

              @if (reviewSnapshot().codes.length > 0) {
                <div class="logic-summary-box">
                  <p class="transformation-type-title">Initial Codes</p>
                  <div class="mapping-review-list">
                    @for (code of reviewSnapshot().codes; track $index) {
                      <div class="mapping-pill">
                        <span class="old">{{ code.codeValue }}</span>
                        <mat-icon>arrow_forward</mat-icon>
                        <span class="new">{{ code.label }}</span>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          </div>

          <div
            class="step-footer-actions"
            [class.dark]="theme() === 'dark'"
            [class.light]="theme() === 'light'">
            <button
              mat-flat-button
              class="back-btn"
              [class.dark]="theme() === 'dark'"
              [class.light]="theme() === 'light'"
              (click)="prevStep()">
              Back
            </button>
            <button mat-flat-button class="next-btn" (click)="nextStep()">
              Create Code Set
            </button>
          </div>
        }

        <!-- STEP 5: CONNECT / NEXT STEPS -->
        @if (activeStep() === 4 && createdCodeSetData()) {
          <div class="step-content step-5-connect">
            <!-- Success Header -->
            <div 
              class="success-header"
              [class.dark]="theme() === 'dark'"
              [class.light]="theme() === 'light'">
              <div class="success-icon">
                <mat-icon>check_circle</mat-icon>
              </div>
              <h2 class="success-title">Code Set created</h2>
              <p class="success-subtitle">
                Connect this Code Set to a mapping or rule so it can be used in normalization.
              </p>
            </div>

            <!-- Two-Column Layout -->
            <div 
              class="connect-grid"
              [class.dark]="theme() === 'dark'"
              [class.light]="theme() === 'light'">
              
              <!-- Left Column: Code Set Summary -->
              <div class="summary-column">
                <h3 class="column-title">Code Set Summary</h3>
                
                <div 
                  class="summary-card"
                  [class.dark]="theme() === 'dark'"
                  [class.light]="theme() === 'light'">
                  <div class="summary-row">
                    <span class="summary-label">Code Set Name:</span>
                    <span class="summary-value">{{ createdCodeSetName() }}</span>
                  </div>

                  <div class="summary-row">
                    <span class="summary-label">System / Authority:</span>
                    <span class="summary-value">
                      {{ createdCodeSetData().basics.codeSystem || 'Custom' }}
                    </span>
                  </div>

                  <div class="summary-row">
                    <span class="summary-label">Version:</span>
                    <span class="summary-value">v1</span>
                  </div>

                  <div class="summary-row">
                    <span class="summary-label">Status:</span>
                    <span class="summary-value">
                      <span class="status-badge draft">Draft</span>
                    </span>
                  </div>

                  <div class="summary-row">
                    <span class="summary-label">Codes created:</span>
                    <span class="summary-value">{{ createdCodeSetData().codes.length }}</span>
                  </div>

                  <div class="summary-row">
                    <span class="summary-label">Created:</span>
                    <span class="summary-value">Just now by Barb</span>
                  </div>
                </div>

                <!-- View Details Link -->
                <button 
                  mat-button 
                  class="view-details-link"
                  (click)="viewCodeSetDetails()">
                  <span>View Code Set details</span>
                  <mat-icon>open_in_new</mat-icon>
                </button>
              </div>

              <!-- Right Column: Next Actions -->
              <div class="actions-column">
                <h3 class="column-title">Next: Connect this Code Set</h3>

                <!-- Create Mapping Button -->
                <button
                  mat-flat-button
                  class="action-card mapping-action"
                  [class.dark]="theme() === 'dark'"
                  [class.light]="theme() === 'light'"
                  (click)="createMappingWithCodeSet()">
                  <div class="action-icon">
                    <mat-icon>compare_arrows</mat-icon>
                  </div>
                  <div class="action-content">
                    <div class="action-title">Create mapping using this Code Set</div>
                    <div class="action-description">
                      Map source values to these codes during normalization
                    </div>
                  </div>
                  <mat-icon class="action-arrow">arrow_forward</mat-icon>
                </button>

                <!-- Create Validation Rule Button -->
                <button
                  mat-flat-button
                  class="action-card validation-action"
                  [class.dark]="theme() === 'dark'"
                  [class.light]="theme() === 'light'"
                  (click)="createValidationRuleForCodeSet()">
                  <div class="action-icon">
                    <mat-icon>verified_user</mat-icon>
                  </div>
                  <div class="action-content">
                    <div class="action-title">Create validation rule for this Code Set</div>
                    <div class="action-description">
                      Validate incoming values against this Code Set
                    </div>
                  </div>
                  <mat-icon class="action-arrow">arrow_forward</mat-icon>
                </button>

                <!-- Divider -->
                <div class="action-divider"></div>

                <!-- Not Now Link -->
                <button 
                  mat-button 
                  class="not-now-link"
                  (click)="finishWithoutConnecting()">
                  Not now
                </button>
              </div>
            </div>
          </div>

          <!-- Step 5 Footer -->
          <div
            class="step-footer-actions"
            [class.dark]="theme() === 'dark'"
            [class.light]="theme() === 'light'">
            <button
              mat-flat-button
              class="back-btn"
              [class.dark]="theme() === 'dark'"
              [class.light]="theme() === 'light'"
              (click)="prevStep()">
              Back
            </button>
            <button 
              mat-flat-button 
              class="next-btn" 
              (click)="finishWithoutConnecting()">
              Done
            </button>
          </div>
        }

      </div>
    </div>
  </div>
} - that may need its payload adjusted to let the table in parent component display.
Below are the methods in normalization.component.ts that send data the way from tab to window within same space: