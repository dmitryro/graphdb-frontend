<div
  class="mapping-detail-container"
  [class.slide-out-to-left]="isEditing"
  [class.slide-in-from-left]="!isEditing">
  <div class="view-content-wrapper">
    <div class="back-navigation">
      <button mat-button class="back-btn" (click)="onBackToMappings()">
        <mat-icon>arrow_back</mat-icon>
        <span>back to Mappings</span>
      </button>
    </div>

    <div class="mapping-header">
      <div class="header-left">
        <div class="page-category">Normalization</div>
        <h1 class="mapping-title">{{ mappingData?.name || 'Epic → Patient' }}</h1>

        <div class="header-metadata">
          <button mat-button class="metadata-pill">
            <mat-icon>hub</mat-icon>
            <span>Source: {{ mappingData?.source || 'Epic Health Network' }}</span>
          </button>
          <button mat-button class="metadata-pill">
            <mat-icon>layers</mat-icon>
            <span>Target: {{ mappingData?.target || 'Patient Model' }}</span>
          </button>

          <div
            class="status-pill"
            [class.active]="mappingData?.status === 'Active' || !mappingData?.status"
            [class.deprecated]="mappingData?.status === 'Deprecated'"
            [class.draft]="mappingData?.status === 'Draft'">
            <mat-icon>
              @if (mappingData?.status === 'Active') {
                check_circle
              } @else if (mappingData?.status === 'Deprecated') {
                block
              } @else {
                edit_note
              }
            </mat-icon>
            <span>{{ mappingData?.status || 'Active' }}</span>
          </div>

          <div class="metadata-text">
            <mat-icon>schedule</mat-icon>
            <span>Last Modified: {{ mappingData?.lastModified || '2 days ago' }}</span>
          </div>
        </div>
      </div>

      <div class="header-actions">
        <button mat-button class="edit-btn" (click)="onEdit()">
          <mat-icon>edit</mat-icon>
          <span>Edit</span>
        </button>

        <button mat-button class="status-dropdown-btn" [matMenuTriggerFor]="statusMenu">
          <span>Change Status</span>
          <mat-icon>expand_more</mat-icon>
        </button>

        <mat-menu #statusMenu="matMenu">
          <button mat-menu-item [disabled]="mappingData?.status === 'Active'">
            <mat-icon class="status-active">check_circle</mat-icon>
            <span>Active {{ mappingData?.status === 'Active' ? '(current)' : '' }}</span>
          </button>
          <button mat-menu-item [disabled]="mappingData?.status === 'Draft'">
            <mat-icon>edit_note</mat-icon>
            <span>Draft {{ mappingData?.status === 'Draft' ? '(current)' : '' }}</span>
          </button>
          <mat-divider></mat-divider>
          <button
            mat-menu-item
            class="danger-action"
            [disabled]="mappingData?.status === 'Deprecated'">
            <mat-icon>block</mat-icon>
            <span
              >Disable / Deprecate...
              {{ mappingData?.status === 'Deprecated' ? '(current)' : '' }}</span
            >
          </button>
        </mat-menu>
      </div>
    </div>

    <div class="content-grid">
      <div class="left-column">
        <div class="info-block overview-block">
          <h2 class="block-title">Overview</h2>
          <p class="description">
            Defines how {{ mappingData?.source || 'Epic EHR' }} fields map into the canonical
            {{ mappingData?.target || 'Patient' }} model for normalization.
          </p>

          <div class="info-grid">
            <div class="info-item">
              <label>Source System</label>
              <span>{{ mappingData?.source || 'Epic Health Network' }}</span>
            </div>
            <div class="info-item">
              <label>Target Model</label>
              <span>{{ mappingData?.target || 'Patient' }}</span>
            </div>
            <div class="info-item">
              <label>Required Coverage</label>
              <span>20 / 20 fields</span>
            </div>
            <div class="info-item">
              <label>Mapped Fields</label>
              <span>22</span>
            </div>
            <div class="info-item">
              <label>Created</label>
              <span>2024-01-15 by Dmitry Roitman</span>
            </div>
            <div class="info-item">
              <label>Last Modified</label>
              <span>{{ mappingData?.lastModified || '2024-02-07' }} by Dmitry Roitman</span>
            </div>
            <div class="info-item">
              <label>Team Ownership</label>
              <span>Data Governance Team</span>
            </div>
            <div class="info-item">
              <label>Structural Completeness</label>
              <span class="completeness-badge complete">Complete</span>
            </div>
          </div>
        </div>

        <div class="field-mappings-section">
          <h2 class="section-title">Field Mappings</h2>

          <div class="field-filters">
            <div class="search-box">
              <mat-icon>search</mat-icon>
              <input
                type="text"
                placeholder="Search source or target fields..."
                [(ngModel)]="searchTerm"
                (input)="applyFilter()" />
            </div>

            <button mat-button class="filter-dropdown" [matMenuTriggerFor]="requirementMenu">
              Requirement: <strong>{{ selectedRequirement }}</strong>
              <mat-icon>expand_more</mat-icon>
            </button>
            <mat-menu #requirementMenu="matMenu">
              <button mat-menu-item (click)="setRequirementFilter('All')">All</button>
              <button mat-menu-item (click)="setRequirementFilter('Required')">Required</button>
              <button mat-menu-item (click)="setRequirementFilter('Optional')">Optional</button>
            </mat-menu>

            <button mat-button class="filter-dropdown" [matMenuTriggerFor]="statusFilterMenu">
              Status: <strong>{{ selectedStatus }}</strong>
              <mat-icon>expand_more</mat-icon>
            </button>
            <mat-menu #statusFilterMenu="matMenu">
              <button mat-menu-item (click)="setStatusFilter('All')">All</button>
              <button mat-menu-item (click)="setStatusFilter('Mapped')">Mapped</button>
              <button mat-menu-item (click)="setStatusFilter('Unmapped')">Unmapped</button>
            </mat-menu>

            <button mat-button class="filter-dropdown" [matMenuTriggerFor]="typeMenu">
              Mapping Type: <strong>{{ selectedMappingType }}</strong>
              <mat-icon>expand_more</mat-icon>
            </button>
            <mat-menu #typeMenu="matMenu">
              <button mat-menu-item (click)="setMappingTypeFilter('All')">All</button>
              <button mat-menu-item (click)="setMappingTypeFilter('Direct')">Direct</button>
              <button mat-menu-item (click)="setMappingTypeFilter('Derived')">Derived</button>
              <button mat-menu-item (click)="setMappingTypeFilter('Constant')">Constant</button>
            </mat-menu>

            <div class="rows-count">1 – 5 of {{ fieldMappingDataSource.data.length }} fields</div>
          </div>

          <table mat-table [dataSource]="fieldMappingDataSource" matSort class="mapping-table">
            <ng-container matColumnDef="sourceField">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Source Field</th>
              <td mat-cell *matCellDef="let element" class="field-name">
                {{ element.sourceField }}
              </td>
            </ng-container>

            <ng-container matColumnDef="targetField">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Target Field</th>
              <td mat-cell *matCellDef="let element" class="field-name">
                {{ element.targetField }}
              </td>
            </ng-container>

            <ng-container matColumnDef="type">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Type</th>
              <td mat-cell *matCellDef="let element">{{ element.type }}</td>
            </ng-container>

            <ng-container matColumnDef="requirement">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Requirement</th>
              <td mat-cell *matCellDef="let element">
                <span [class.required-field]="element.requirement === 'Required'">
                  {{ element.requirement }}
                </span>
              </td>
            </ng-container>

            <ng-container matColumnDef="mappingType">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Mapping Type</th>
              <td mat-cell *matCellDef="let element">{{ element.mappingType }}</td>
            </ng-container>

            <ng-container matColumnDef="notes">
              <th mat-header-cell *matHeaderCellDef>Notes</th>
              <td mat-cell *matCellDef="let element" class="notes-cell">{{ element.notes }}</td>
            </ng-container>

            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
              <td mat-cell *matCellDef="let element">
                <span
                  class="status-badge"
                  [class.mapped]="element.status === 'Mapped'"
                  [class.unmapped]="element.status === 'Unmapped'">
                  {{ element.status }}
                </span>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="fieldMappingColumns; sticky: true"></tr>
            <tr mat-row *matRowDef="let row; columns: fieldMappingColumns"></tr>
          </table>

          <mat-paginator [pageSize]="10" [pageSizeOptions]="[5, 10, 20]"></mat-paginator>
        </div>

        <div class="stats-footer-row">
          <div class="info-block coverage-block">
            <h3 class="block-title">Coverage</h3>
            <p class="block-subtitle">
              Models structurally related through mappings, rules and graph relationships.
            </p>

            <div class="coverage-metrics">
              <div class="metric-row">
                <label>Required fields mapped</label>
                <span class="metric-value">{{ requiredFieldsMapped }}</span>
              </div>
              <div class="metric-row">
                <label>Optional fields mapped</label>
                <span class="metric-value">{{ optionalFieldsMapped }}</span>
              </div>
              <div class="metric-row">
                <label>Unmapped required fields</label>
                <span class="metric-value">{{ unmappedRequiredFields }}</span>
              </div>
              <div class="metric-row">
                <label>Structural completeness</label>
                <span class="completeness-badge complete">
                  <mat-icon>check_circle</mat-icon>
                  {{ structuralCompleteness }}
                </span>
              </div>
            </div>
          </div>

          <div class="info-block usage-block">
            <h3 class="block-title">Usage & Impact</h3>

            <div class="usage-item">
              <button mat-button class="expand-btn" (click)="togglePipelines()">
                <label>Used in pipelines</label>
                <span class="count">2</span>
                <mat-icon>{{ pipelinesExpanded ? 'expand_less' : 'expand_more' }}</mat-icon>
              </button>

              @if (pipelinesExpanded) {
                <div class="expanded-content">
                  <a href="#" class="pipeline-link">Patient Normalization Pipeline</a>
                  <a href="#" class="pipeline-link">Nightly Epic Sync</a>
                </div>
              }
            </div>

            <div class="usage-item">
              <button mat-button class="expand-btn" (click)="toggleRules()">
                <label>Referenced by rules</label>
                <span class="count">5</span>
                <mat-icon>{{ rulesExpanded ? 'expand_less' : 'expand_more' }}</mat-icon>
              </button>

              @if (rulesExpanded) {
                <div class="expanded-content">
                  <a href="#" class="rule-link">Demographic Field Rules</a>
                  <a href="#" class="rule-link">Patient Record Validation Rules</a>
                  <a href="#" class="rule-link">Admission Record Validation Rules</a>
                  <a href="#" class="rule-link">Duplicate Record Check Rules</a>
                  <a href="#" class="rule-link">Orphaned Record Detection Rules</a>
                </div>
              }
            </div>

            <div class="usage-row">
              <label>Target model</label>
              <span>{{ mappingData?.target || 'Patient' }}</span>
            </div>
            <div class="usage-row">
              <label>Normalization usage</label>
              <span [class.active-text]="mappingData?.status === 'Active'">{{
                mappingData?.status || 'Active'
              }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="right-column">
        <div class="info-block quick-links-block">
          <h3 class="block-title">Quick Links</h3>
          <button mat-button class="link-item" (click)="viewInVersions()">
            <mat-icon>history</mat-icon>
            <span>View in Versions</span>
            <mat-icon class="arrow">arrow_forward</mat-icon>
          </button>
          <button mat-button class="link-item" (click)="viewInRules()">
            <mat-icon>rule</mat-icon>
            <span>View in Rules</span>
            <mat-icon class="arrow">arrow_forward</mat-icon>
          </button>
          <button mat-button class="link-item" (click)="viewTargetModel()">
            <mat-icon>layers</mat-icon>
            <span>View Target Model ({{ mappingData?.target || 'Patient' }})</span>
            <mat-icon class="arrow">arrow_forward</mat-icon>
          </button>
        </div>

        <div class="info-block status-block">
          <h3 class="block-title">Status</h3>
          <div
            class="status-pill large"
            [class.active]="mappingData?.status === 'Active' || !mappingData?.status"
            [class.deprecated]="mappingData?.status === 'Deprecated'"
            [class.draft]="mappingData?.status === 'Draft'">
            <mat-icon>
              @if (mappingData?.status === 'Active') {
                check_circle
              } @else if (mappingData?.status === 'Deprecated') {
                block
              } @else {
                edit_note
              }
            </mat-icon>
            <span>{{ mappingData?.status || 'Active' }}</span>
          </div>
          <p class="status-description">
            @if (mappingData?.status === 'Deprecated') {
              This mapping is legacy and no longer recommended for active normalization.
            } @else {
              Used in canonical normalization and downstream systems.
            }
          </p>
        </div>

        <div class="info-block versions-block">
          <h3 class="block-title">Versions</h3>

          <div class="version-list">
            @for (version of versions; track version.version) {
              <div class="version-item">
                <div class="version-header">
                  <strong>{{ version.version }}</strong>
                  @if (version.action !== 'Created') {
                    <span> — {{ version.action }} by {{ version.editor }}</span>
                  } @else {
                    <span> — {{ version.action }}</span>
                  }
                </div>
                <div class="version-time">{{ version.timestamp }}</div>
              </div>
            }
          </div>

          <button mat-button class="view-all-link" (click)="viewVersionHistory()">
            View full version history
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
