<div class="normalization-main-container">
  <header class="normalization-header">
    <div class="breadcrumb-area">
      <div class="breadcrumb">Normalization</div>
      <div class="title-row">
        <h1>Normalization</h1>
      </div>
      <p class="subtitle">
        Define how raw inputs are transformed into canonical, structured records for the MPI Golden
        Record.
      </p>
    </div>

    <div class="workspace-area">
      <mat-form-field appearance="outline" class="workspace-select">
        <mat-select [(value)]="selectedEnv">
          <mat-option value="Production">Production</mat-option>
          <mat-option value="Staging">Staging</mat-option>
          <mat-option value="Development">Development</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </header>

  <div class="table-card">
    <div class="tabs-section">
      <mat-tab-group
        class="normalization-tabs"
        [(selectedIndex)]="activeTabIndex"
        (selectedTabChange)="onTabChange($event)">
        <mat-tab label="Models"></mat-tab>
        <mat-tab label="Mappings"></mat-tab>
        <mat-tab label="Rules"></mat-tab>
        <mat-tab label="Versions"></mat-tab>
        <mat-tab label="Codes"></mat-tab>
      </mat-tab-group>
    </div>

    <div class="tab-content" *ngIf="activeTabIndex === 0">
      <div class="search-section">
        <div class="search-bar-container">
          <div class="search-box">
            <mat-icon class="search-icon">search</mat-icon>
            <input
              type="text"
              class="search-input"
              placeholder="Search models..."
              [(ngModel)]="modelSearch"
              (input)="applyModelFilter()" />
            <button
              mat-icon-button
              *ngIf="modelSearch"
              (click)="modelSearch = ''; applyModelFilter()">
              <mat-icon>close</mat-icon>
            </button>
          </div>
          <button mat-flat-button class="add-source-btn" (click)="addNewModel()">
            <mat-icon>add</mat-icon> New Model
          </button>
        </div>
      </div>
      <div class="filter-actions">
        <button mat-button class="filter-dropdown">
          <mat-icon>list</mat-icon> Status <mat-icon class="chevron">expand_more</mat-icon>
        </button>
        <button mat-button class="filter-dropdown">
          <mat-icon>layers</mat-icon> Type <mat-icon class="chevron">expand_more</mat-icon>
        </button>
      </div>
      <table mat-table [dataSource]="modelDataSource" matSort class="full-width-table">
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Model Name</th>
          <td mat-cell *matCellDef="let element" class="primary-text">{{ element.name }}</td>
        </ng-container>
        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Type</th>
          <td mat-cell *matCellDef="let element">{{ element.type }}</td>
        </ng-container>
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
          <td mat-cell *matCellDef="let element">
            <div class="status-pill" [ngClass]="element.status.toLowerCase()">
              <mat-icon>check_circle</mat-icon>{{ element.status }}
            </div>
          </td>
        </ng-container>
        <ng-container matColumnDef="fields">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Fields</th>
          <td mat-cell *matCellDef="let element">{{ element.fields }}</td>
        </ng-container>
        <ng-container matColumnDef="dependencies">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Dependencies</th>
          <td mat-cell *matCellDef="let element">{{ element.dependencies }}</td>
        </ng-container>
        <ng-container matColumnDef="lastModified">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Last Modified</th>
          <td mat-cell *matCellDef="let element">{{ element.lastModified }}</td>
        </ng-container>
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let element">
            <button
              mat-icon-button
              [matMenuTriggerFor]="modelMenu"
              [matMenuTriggerData]="{ item: element }">
              <mat-icon>more_vert</mat-icon>
            </button>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="modelColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: modelColumns"></tr>
      </table>
      <mat-paginator
        #modelPaginator
        [pageSize]="5"
        [pageSizeOptions]="[5, 10, 20, 50]"
        showFirstLastButtons></mat-paginator>
    </div>

    <div class="tab-content" *ngIf="activeTabIndex === 1">
      <div class="search-section">
        <div class="search-bar-container">
          <div class="search-box">
            <mat-icon class="search-icon">search</mat-icon>
            <input
              type="text"
              class="search-input"
              placeholder="Search mappings..."
              [(ngModel)]="mappingSearch"
              (input)="applyMappingFilter()" />
          </div>
          <button mat-flat-button class="add-source-btn" (click)="addNewMapping()">
            <mat-icon>add</mat-icon> New Mapping
          </button>
        </div>
      </div>
      <table mat-table [dataSource]="mappingDataSource" matSort class="full-width-table">
        <ng-container matColumnDef="source">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Source System</th>
          <td mat-cell *matCellDef="let element" class="primary-text">{{ element.source }}</td>
        </ng-container>
        <ng-container matColumnDef="target">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Target FHIR</th>
          <td mat-cell *matCellDef="let element">{{ element.target }}</td>
        </ng-container>
        <ng-container matColumnDef="engine">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Engine</th>
          <td mat-cell *matCellDef="let element">{{ element.engine }}</td>
        </ng-container>
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
          <td mat-cell *matCellDef="let element">
            <div class="status-pill active">{{ element.status }}</div>
          </td>
        </ng-container>
        <ng-container matColumnDef="lastModified">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Last Modified</th>
          <td mat-cell *matCellDef="let element">{{ element.lastModified }}</td>
        </ng-container>
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let element">
            <button
              mat-icon-button
              [matMenuTriggerFor]="modelMenu"
              [matMenuTriggerData]="{ item: element }">
              <mat-icon>more_vert</mat-icon>
            </button>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="mappingColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: mappingColumns"></tr>
      </table>
      <mat-paginator
        #mappingPaginator
        [pageSize]="5"
        [pageSizeOptions]="[5, 10, 20, 50]"
        showFirstLastButtons></mat-paginator>
    </div>

    <div class="tab-content" *ngIf="activeTabIndex === 2">
      <div class="search-section">
        <div class="search-bar-container">
          <div class="search-box">
            <mat-icon class="search-icon">search</mat-icon>
            <input
              type="text"
              class="search-input"
              placeholder="Search rules..."
              [(ngModel)]="ruleSearch"
              (input)="applyRuleFilter()" />
          </div>
          <button mat-flat-button class="add-source-btn" (click)="addNewRule()">
            <mat-icon>add</mat-icon> New Rule
          </button>
        </div>
      </div>
      <table mat-table [dataSource]="ruleDataSource" matSort class="full-width-table">
        <ng-container matColumnDef="ruleName">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Rule Name</th>
          <td mat-cell *matCellDef="let element" class="primary-text">{{ element.ruleName }}</td>
        </ng-container>
        <ng-container matColumnDef="trigger">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Trigger</th>
          <td mat-cell *matCellDef="let element">{{ element.trigger }}</td>
        </ng-container>
        <ng-container matColumnDef="priority">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Priority</th>
          <td mat-cell *matCellDef="let element">{{ element.priority }}</td>
        </ng-container>
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
          <td mat-cell *matCellDef="let element">
            <div class="status-pill active">{{ element.status }}</div>
          </td>
        </ng-container>
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let element">
            <button
              mat-icon-button
              [matMenuTriggerFor]="modelMenu"
              [matMenuTriggerData]="{ item: element }">
              <mat-icon>more_vert</mat-icon>
            </button>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="ruleColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: ruleColumns"></tr>
      </table>
      <mat-paginator
        #rulePaginator
        [pageSize]="5"
        [pageSizeOptions]="[5, 10, 20, 50]"
        showFirstLastButtons></mat-paginator>
    </div>

    <div class="tab-content" *ngIf="activeTabIndex === 3">
      <div class="search-filter-wrapper">
        <div class="version-controls-row">
          <div class="search-box-version">
            <mat-icon>search</mat-icon>
            <input
              type="text"
              placeholder="Search by model, mapping, rule, or user..."
              [(ngModel)]="versionSearch"
              (input)="applyVersionFilter()" />

            <span class="v-divider">|</span>

            <div class="date-range-container">
              <mat-date-range-input [formGroup]="range" [rangePicker]="picker">
                <input matStartDate formControlName="start" placeholder="Start date" />
                <input matEndDate formControlName="end" placeholder="End date" />
              </mat-date-range-input>
              <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-date-range-picker #picker></mat-date-range-picker>

              <button
                mat-icon-button
                *ngIf="range.value.start"
                (click)="clearDateRange()"
                class="clear-date-btn">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>

          <div class="version-meta-actions">
            <span class="v-count"
              >{{ pagedVersionHistory.length }} of {{ versionHistory.length }} versions</span
            >
            <button mat-icon-button title="Refresh History" (click)="loadAllData()">
              <mat-icon>history</mat-icon>
            </button>
            <button mat-icon-button><mat-icon>toll</mat-icon></button>
            <button mat-icon-button><mat-icon>more_vert</mat-icon></button>
          </div>
        </div>

        <div class="version-filters-bar">
          <div class="spacer"></div>
          <mat-paginator
            #versionPaginator
            [length]="filteredVersionHistory.length"
            [pageSize]="pageSize"
            [pageSizeOptions]="[5, 10, 20, 50]"
            showFirstLastButtons
            class="compact-paginator">
          </mat-paginator>
        </div>

        <div class="timeline-container">
          @for (commit of pagedVersionHistory; track commit.hash) {
            <div class="timeline-card">
              <div class="card-header">
                <img [src]="commit.author.avatar" class="avatar" />
                <span class="rel-time">{{ commit.relativeTime }}</span>
                <span class="abs-time">{{ commit.absoluteTime }}</span>
                <code class="hash">{{ commit.hash }}</code>
                <span class="author">{{ commit.author.name }}</span>
                <div class="spacer"></div>
                <div class="header-actions">
                  <mat-icon>history</mat-icon>
                  <mat-icon>share</mat-icon>
                  <mat-icon>more_vert</mat-icon>
                  <mat-icon class="toggle">expand_more</mat-icon>
                </div>
              </div>

              <div class="card-body">
                @for (event of commit.events; track $index) {
                  <div class="timeline-event">
                    <div class="event-icon" [ngClass]="event.action.toLowerCase()">
                      <mat-icon>{{ event.action === 'Added' ? 'add_box' : 'edit' }}</mat-icon>
                    </div>
                    <div class="event-text">
                      <span class="bold">{{ event.action }}</span>
                      <span class="subject">{{ event.subject }}</span>
                      <span class="ver">{{ event.version }}</span>
                      <span class="muted" *ngIf="event.meta">, {{ event.meta }}.</span>
                      <div class="sub-detail" *ngIf="event.scopeChange">
                        Scope changed: <strong>{{ event.scopeChange }}</strong>
                      </div>
                    </div>
                    <span class="event-time">{{ event.timestamp }}</span>
                  </div>

                  @if (event.nested) {
                    <div class="tree-container">
                      <div class="tree-line"></div>
                      <div class="tree-node">
                        <mat-icon [ngClass]="event.statusIcon">assignment</mat-icon>
                        <span class="node-title">{{ event.nested.title }}</span>
                        <span class="node-tag" [ngClass]="event.type.toLowerCase()">{{
                          event.nested.tag
                        }}</span>
                        <div class="spacer"></div>
                        <span class="node-time">{{ event.nested.time }}</span>
                        <mat-icon class="check" *ngIf="event.statusIcon === 'check_circle'"
                          >check_circle</mat-icon
                        >
                        <mat-icon class="info" *ngIf="event.statusIcon === 'info_outline'"
                          >info_outline</mat-icon
                        >
                      </div>
                    </div>
                  }
                }

                <div class="timeline-row-item">
                  <mat-icon class="edit-icon">arrow_forward</mat-icon>
                  <span class="label">Edited</span>
                  <mat-icon class="type-icon mapping">description</mat-icon>
                  <span class="subject">Age Under 18 (v2)</span>
                  <span class="muted">, renod Episode Missing Encounter Date (v3)</span>
                  <span class="node-tag mapping">Mapping</span>
                  <div class="spacer"></div>
                  <span class="row-time">2 days ago</span>
                  <mat-icon class="info">info_outline</mat-icon>
                </div>

                <div class="timeline-row-item">
                  <img src="https://ui-avatars.com/api/?name=U" class="mini-avatar" />
                  <span class="label">Added</span>
                  <mat-icon class="type-icon added">add_box</mat-icon>
                  <span class="subject">Epic → Patient (v3)</span>
                  <span class="node-tag model">Model</span>
                  <span class="meta">Field count: 28 → 30</span>
                  <div class="spacer"></div>
                  <span class="row-time">5 hours ago</span>
                </div>
              </div>
            </div>
          } @empty {
            <div class="empty-state">
              No version history available for the selected range or search.
            </div>
          }
        </div>
      </div>
    </div>

    <div class="tab-content" *ngIf="activeTabIndex === 4">
      <div class="search-section">
        <div class="search-bar-container">
          <div class="search-box">
            <mat-icon class="search-icon">search</mat-icon>
            <input
              type="text"
              class="search-input"
              placeholder="Search code systems..."
              [(ngModel)]="codeSearch"
              (input)="applyCodeFilter()" />
          </div>
          <button mat-flat-button class="add-source-btn" (click)="addNewCodeSystem()">
            <mat-icon>add</mat-icon> New Code
          </button>
        </div>
      </div>
      <table mat-table [dataSource]="codeDataSource" matSort class="full-width-table">
        <ng-container matColumnDef="codeSystem">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>System</th>
          <td mat-cell *matCellDef="let element" class="primary-text">{{ element.codeSystem }}</td>
        </ng-container>
        <ng-container matColumnDef="standard">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Standard</th>
          <td mat-cell *matCellDef="let element">{{ element.standard }}</td>
        </ng-container>
        <ng-container matColumnDef="oid">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>OID</th>
          <td mat-cell *matCellDef="let element">{{ element.oid }}</td>
        </ng-container>
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
          <td mat-cell *matCellDef="let element">
            <div class="status-pill active">{{ element.status }}</div>
          </td>
        </ng-container>
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let element">
            <button
              mat-icon-button
              [matMenuTriggerFor]="modelMenu"
              [matMenuTriggerData]="{ item: element }">
              <mat-icon>more_vert</mat-icon>
            </button>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="codeColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: codeColumns"></tr>
      </table>
      <mat-paginator
        #codePaginator
        [pageSize]="5"
        [pageSizeOptions]="[5, 10, 20, 50]"
        showFirstLastButtons></mat-paginator>
    </div>

    <mat-menu #modelMenu="matMenu" class="compact-list-menu" xPosition="before">
      <ng-template matMenuContent let-item="item">
        <button mat-menu-item (click)="onEdit(item)">
          <mat-icon>edit</mat-icon><span>Edit</span>
        </button>
        <button mat-menu-item (click)="onViewLogs(item)">
          <mat-icon>history</mat-icon><span>View Logs</span>
        </button>
        <div class="menu-divider danger-divider"></div>
        <button mat-menu-item class="delete-action" (click)="onDelete(item)">
          <mat-icon>delete_forever</mat-icon><span>Delete</span>
        </button>
      </ng-template>
    </mat-menu>
  </div>
</div>
