<div class="modal-overlay" *ngIf="isOpen">
  <div
    #modalContainer
    class="modal-container"
    [class.dark]="theme === 'dark'"
    [class.light]="theme === 'light'">
    <header class="modal-header" [class.dark]="theme === 'dark'" [class.light]="theme === 'light'">
      <div class="header-title">
        <mat-icon>account_tree</mat-icon>
        <div>
          <h2>Normalization Model Builder</h2>
          <span class="subtitle">Step-by-Step Schema Configuration</span>
        </div>
      </div>
      <button mat-icon-button (click)="close()">
        <mat-icon>close</mat-icon>
      </button>
    </header>

    <div class="modal-body" [class.dark]="theme === 'dark'" [class.light]="theme === 'light'">
      <mat-stepper
        #stepper
        [class.dark-stepper]="theme === 'dark'"
        [class.light-stepper]="theme === 'light'">
        <mat-step [stepControl]="normalizationForm">
          <form [formGroup]="normalizationForm" class="step-content">
            <ng-template matStepLabel>Setup Schema</ng-template>

            <div class="form-row">
              <mat-form-field
                appearance="outline"
                class="flex-2"
                [class.dark-field]="theme === 'dark'"
                [class.light-field]="theme === 'light'">
                <mat-label>Model Name</mat-label>
                <input matInput formControlName="name" placeholder="e.g. Patient_Event" />
              </mat-form-field>

              <mat-form-field
                appearance="outline"
                class="flex-1"
                [class.dark-field]="theme === 'dark'"
                [class.light-field]="theme === 'light'">
                <mat-label>Model Type</mat-label>
                <mat-select formControlName="type">
                  <mat-option value="Canonical">Canonical</mat-option>
                  <mat-option value="Derived">Derived</mat-option>
                  <mat-option value="External">External</mat-option>
                </mat-select>
              </mat-form-field>
            </div>

            <div class="property-list-container" formArrayName="properties">
              <div
                *ngFor="let prop of properties.controls; let i = index"
                [formGroupName]="i"
                class="property-row">
                <mat-form-field
                  appearance="outline"
                  class="flex-2"
                  [class.dark-field]="theme === 'dark'"
                  [class.light-field]="theme === 'light'">
                  <mat-label>Property Name</mat-label>
                  <input matInput formControlName="propertyName" placeholder="field_name" />
                </mat-form-field>

                <mat-form-field
                  appearance="outline"
                  class="flex-1"
                  [class.dark-field]="theme === 'dark'"
                  [class.light-field]="theme === 'light'">
                  <mat-label>Type</mat-label>
                  <input
                    matInput
                    formControlName="propertyType"
                    placeholder="String, Integer, etc." />
                </mat-form-field>

                <button
                  mat-icon-button
                  color="warn"
                  (click)="removeProperty(i)"
                  *ngIf="properties.length > 1">
                  <mat-icon>remove_circle</mat-icon>
                </button>
              </div>
            </div>

            <button mat-stroked-button type="button" class="add-btn" (click)="addProperty()">
              <mat-icon>add</mat-icon> Add New Field
            </button>

            <div class="step-actions">
              <button mat-button (click)="close()">Cancel</button>
              <button
                mat-flat-button
                color="primary"
                matStepperNext
                [disabled]="normalizationForm.invalid">
                Continue
              </button>
            </div>
          </form>
        </mat-step>

        <mat-step>
          <div class="step-content">
            <ng-template matStepLabel>Review Fields</ng-template>

            <div
              class="summary-box"
              [class.dark]="theme === 'dark'"
              [class.light]="theme === 'light'">
              <p><strong>Entity:</strong> {{ normalizationForm.value.name }}</p>
              <p><strong>Classification:</strong> {{ normalizationForm.value.type }}</p>
            </div>

            <div class="modal-table-container" [class.light-table]="theme === 'light'">
              <table>
                <thead>
                  <tr class="mat-mdc-header-row">
                    <th class="mat-mdc-header-cell">Field Name</th>
                    <th class="mat-mdc-header-cell">Data Type</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let p of normalizationForm.value.properties" class="mat-mdc-row">
                    <td class="mat-mdc-cell">{{ p.propertyName }}</td>
                    <td class="mat-mdc-cell">
                      <span class="type-badge">{{ p.propertyType }}</span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="step-actions">
              <button mat-button matStepperPrevious>Back</button>
              <button mat-flat-button color="primary" matStepperNext>Proceed to Deployment</button>
            </div>
          </div>
        </mat-step>

        <mat-step>
          <div class="step-content centered">
            <ng-template matStepLabel>Final Confirmation</ng-template>

            <div class="final-card" [class.dark]="theme === 'dark'">
              <mat-icon color="primary" class="big-icon">cloud_upload</mat-icon>
              <h3>Ready to Deploy</h3>
              <p>
                This action will persist the model to the MPI Graph of Events using
                <code>execute_merge_query_with_context</code>.
              </p>
            </div>

            <div class="step-actions">
              <button mat-button matStepperPrevious>Back</button>
              <button mat-flat-button color="primary" (click)="confirmAction()">
                Deploy Model
              </button>
            </div>
          </div>
        </mat-step>
      </mat-stepper>
    </div>
  </div>
</div>
